<!DOCTYPE html>
<html lang="en" class="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title id="pageTitle">eLGU Monitoring System</title>
  <link rel="icon" type="image/png" href="https://files.e.gov.ph/elgu/9c1a30c1-fd98-4bff-9548-01024c0efd8c.png">

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            dict: { blue: '#003399', red: '#CE1126', yellow: '#FDC116' },
            slate: { 850: '#1e293b', 900: '#0f172a' }
          },
          animation: { 'slide-in': 'slideIn 0.3s ease-out' },
          keyframes: { slideIn: { '0%': { transform: 'translateX(-100%)' }, '100%': { transform: 'translateX(0)' } } }
        }
      }
    }
  </script>

  <style>
    body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
    html, body { background: transparent !important; }

    * { transition: background-color 0.15s, border-color 0.15s, color 0.15s; }
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
    .dark ::-webkit-scrollbar-thumb { background: #475569; }

    .glass-panel { 
        background: rgba(255, 255, 255, 0.65); 
        backdrop-filter: blur(8px);
        border: 1px solid rgba(255, 255, 255, 0.6); 
        border-radius: 1rem; 
        box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); 
    }
    .dark .glass-panel { 
        background: rgba(30, 41, 59, 0.6); 
        border-color: rgba(255, 255, 255, 0.1); 
    }

    .nav-tab.active { background: #003399; color: white; border-color: #003399; }
    .dark .nav-tab.active { background: #3b82f6; border-color: #3b82f6; color: white; }

    .sb-btn { width: 100%; text-align: left; padding: 12px 16px; font-size: 13px; font-weight: 600; display: flex; align-items: center; justify-content: space-between; border-radius: 12px; color: #64748b; background: transparent; cursor: margin-bottom: 4px; }
    .dark .sb-btn { color: #94a3b8; }
    .sb-btn:hover { background: rgba(241, 245, 249, 0.8); }
    .dark .sb-btn:hover { background: rgba(51, 65, 85, 0.5); }
    .sb-btn.active { background: #eff6ff; color: #003399; font-weight: 800; }
    .dark .sb-btn.active { background: rgba(59, 130, 246, 0.15); color: #60a5fa; }
    
    .sb-pill { font-size: 11px; font-weight: 800; padding: 2px 8px; border-radius: 999px; background: #e2e8f0; color: #475569; }
    .dark .sb-pill { background: #334155; color: #cbd5e1; }

    .section-header { background: rgba(248, 250, 252, 0.8); color: #475569; padding: 8px 12px; font-weight: 800; font-size: 11px; text-transform: uppercase; border-radius: 6px; margin-top: 16px; margin-bottom: 10px; border-left: 3px solid #003399; display: flex; align-items: center; gap: 8px; }
    .dark .section-header { background: rgba(15, 23, 42, 0.6); color: #94a3b8; border-left-color: #3b82f6; }

    .badge { font-size: 0.7rem; font-weight: 700; padding: 4px 10px; border-radius: 8px; text-transform: uppercase; white-space: nowrap; }

    .modal { opacity: 0; pointer-events: none; transform: scale(0.95); transition: all 0.2s cubic-bezier(0.16, 1, 0.3, 1); z-index: 120; }
    .modal.active { opacity: 1; pointer-events: auto; transform: scale(1); }

    #map { height: 100%; width: 100%; border-radius: 0.75rem; z-index: 1; }
    #view-map { min-height: 400px; }

    .chart-expand-btn { position: absolute; top: 12px; right: 12px; color: #94a3b8; cursor: pointer; padding: 6px; border-radius: 6px; font-size: 14px; background: transparent; z-index: 10; transition: all 0.2s; }
    .chart-expand-btn:hover { background: #f1f5f9; color: #003399; transform: scale(1.1); }

    .chat-bubble { max-width: 85%; padding: 12px 16px; border-radius: 16px; font-size: 0.9rem; margin-bottom: 12px; line-height: 1.5; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
    .user-msg { background: #003399; color: white; align-self: flex-end; border-bottom-right-radius: 2px; }
    .ai-msg { background: white; color: #334155; align-self: flex-start; border: 1px solid #e2e8f0; border-bottom-left-radius: 2px; }
    .dark .ai-msg { background: #1e293b; border-color: #334155; color: #e2e8f0; }

    .mobile-drawer { position: fixed; top: 0; left: 0; bottom: 0; width: 280px; transform: translateX(-100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); z-index: 50; }
    .mobile-drawer.open { transform: translateX(0); }
    .drawer-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 40; opacity: 0; pointer-events: none; transition: opacity 0.3s; }
    .drawer-overlay.open { opacity: 1; pointer-events: auto; }
    
    .stat-pill { display: inline-flex; align-items: center; justify-content: space-between; width: 100%; padding: 2px 0px; font-size: 9px; font-weight: 700; white-space: nowrap; }
    .dark .stat-pill { border-color: rgba(255,255,255,0.1); }

    .toggle-checkbox:checked { right: 0; border-color: #68D391; }
    .toggle-checkbox:checked + .toggle-label { background-color: #68D391; }

    .ai-msg table { width: 100%; border-collapse: collapse; margin-top: 8px; margin-bottom: 8px; font-size: 0.85rem; }
    .ai-msg th { background-color: #f1f5f9; color: #475569; font-weight: 800; padding: 8px; text-transform: uppercase; font-size: 0.7rem; border: 1px solid #e2e8f0; }
    .dark .ai-msg th { background-color: #1e293b; color: #cbd5e1; border-color: #334155; }
    .ai-msg td { border: 1px solid #e2e8f0; padding: 8px; }
    .dark .ai-msg td { border-color: #334155; }
  </style>
</head>

<body class="h-[100dvh] flex flex-col overflow-hidden text-slate-800 dark:text-slate-100">

  <div style="background-image: url('elgu-bg.jpg');" 
       class="fixed inset-0 z-[-2] w-full h-full bg-cover bg-bottom bg-no-repeat bg-fixed">
  </div>

  <div class="fixed inset-0 z-[-1] w-full h-full bg-slate-50/85 dark:bg-slate-950/90 backdrop-blur-[2px]"></div>
  
  <div id="forceUpdateModal" class="fixed inset-0 z-[9999] hidden flex flex-col items-center justify-center bg-slate-900/95 backdrop-blur-md p-6 text-center animate-in fade-in duration-300">
    <div class="bg-white dark:bg-slate-800 p-8 rounded-3xl shadow-2xl max-w-md w-full border border-slate-200 dark:border-slate-700 transform transition-all scale-100">
      <div class="w-20 h-20 bg-blue-50 dark:bg-blue-900/30 rounded-full flex items-center justify-center mx-auto mb-6">
        <i class="fa-solid fa-cloud-arrow-down text-4xl text-dict-blue dark:text-blue-400 animate-bounce"></i>
      </div>
      <h2 class="text-2xl font-black text-slate-900 dark:text-white mb-2">Update Required</h2>
      <p class="text-slate-500 dark:text-slate-400 text-sm mb-8 leading-relaxed">A newer version is available.</p>
      <a id="downloadLink" href="#" target="_blank" class="block w-full bg-dict-blue hover:bg-blue-700 text-white font-black text-sm py-4 rounded-xl shadow-lg shadow-blue-900/20 transition-all hover:scale-[1.02] active:scale-[0.98] mb-4">DOWNLOAD LATEST VERSION</a>
      <p class="text-[10px] text-slate-400 font-mono">Current: v1.10 <span class="mx-2">•</span> <span id="remoteVersionDisplay">Checking...</span></p>
    </div>
  </div>

  <div id="loadingOverlay" class="fixed inset-0 bg-white/90 dark:bg-slate-950/90 z-[150] hidden flex flex-col items-center justify-center backdrop-blur-sm">
    <div class="w-12 h-12 border-4 border-slate-200 border-t-dict-blue rounded-full animate-spin mb-4"></div>
    <div id="loaderText" class="text-xs font-black text-dict-blue dark:text-blue-400 animate-pulse uppercase tracking-widest">Syncing Data...</div>
  </div>

  <div class="md:hidden h-16 bg-white/90 dark:bg-slate-900/90 backdrop-blur-md border-b dark:border-slate-800 flex items-center justify-between px-4 shrink-0 z-30">
      <button onclick="toggleDrawer()" class="p-2 text-slate-500"><i class="fa-solid fa-bars text-xl"></i></button>
      <span class="font-black text-dict-blue dark:text-blue-400">eLGU Monitoring</span>
      <button onclick="switchTab('ai')" class="p-2 text-indigo-600"><i class="fa-solid fa-sparkles"></i></button>
  </div>

  <header class="bg-white/90 dark:bg-slate-900/90 backdrop-blur-md border-b border-slate-200/50 dark:border-slate-800/50 h-16 hidden md:flex items-center justify-between px-6 z-30 shrink-0 shadow-sm">
    <div class="flex items-center gap-4">
      <img id="logoDict" src="https://upload.wikimedia.org/wikipedia/commons/a/aa/DICT-Logo-icon_only.png" class="h-10 w-auto">
      <div class="h-8 w-px bg-slate-200 dark:bg-slate-700"></div>
      <img id="logoElgu" src="https://files.e.gov.ph/elgu/9c1a30c1-fd98-4bff-9548-01024c0efd8c.png" class="h-8 w-auto">
      <div class="ml-2">
        <h1 class="text-xl font-black text-dict-blue dark:text-blue-400 leading-tight tracking-tighter">eLGU Monitoring System</h1>
        <p class="text-[9px] text-slate-500 font-bold uppercase tracking-widest">v1.10</p>
      </div>
    </div>
    <div class="flex items-center gap-3">
      <div id="statusIndicator" class="hidden flex items-center gap-2 bg-green-50 dark:bg-green-900/30 text-green-700 dark:text-green-400 px-3 py-1.5 rounded-full border border-green-200 dark:border-green-900 text-[10px] font-bold">
        <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div> <span id="statusText">Live</span>
      </div>
      <button onclick="toggleTheme()" class="w-9 h-9 rounded-full bg-slate-100 dark:bg-slate-800 flex items-center justify-center hover:bg-slate-200 dark:hover:bg-slate-700 transition"><i class="fa-solid fa-moon dark:hidden text-slate-500"></i><i class="fa-solid fa-sun hidden dark:block text-slate-400"></i></button>
      <div class="h-6 w-px bg-slate-200 dark:bg-slate-700 mx-1"></div>
      <button onclick="switchTab('dash')" id="btn-dash" class="nav-tab active bg-dict-blue text-white text-xs font-bold px-4 py-2 rounded-lg transition shadow-sm">Dashboard</button>
      <button onclick="switchTab('map')" id="btn-map" class="nav-tab bg-white dark:bg-slate-800 text-slate-600 dark:text-slate-300 text-xs font-bold px-4 py-2 rounded-lg border border-slate-200 dark:border-slate-700 hover:bg-slate-50 transition">Map</button>
      <button onclick="switchTab('ai')" id="btn-ai" class="nav-tab bg-gradient-to-r from-violet-600 to-indigo-600 text-white text-xs font-bold px-4 py-2 rounded-lg shadow-md hover:from-violet-500 hover:to-indigo-500 transition flex gap-2 items-center"><i class="fa-solid fa-sparkles"></i> AI Analyst</button>
      <button onclick="toggleSettings()" class="text-slate-400 hover:text-dict-blue transition p-2 ml-2"><i class="fa-solid fa-gear"></i></button>
    </div>
  </header>

  <div class="flex flex-1 overflow-hidden relative">
    <div id="drawerOverlay" class="drawer-overlay md:hidden" onclick="toggleDrawer()"></div>

    <aside id="sidebar" class="mobile-drawer md:relative md:translate-x-0 md:w-64 bg-white/80 dark:bg-slate-900/80 backdrop-blur-xl border-r border-slate-200 dark:border-slate-800 flex flex-col shrink-0 z-50 shadow-2xl md:shadow-none">
      <div class="p-4 md:hidden flex justify-between items-center border-b dark:border-slate-800">
          <span class="font-black">Menu</span>
          <button onclick="toggleDrawer()"><i class="fa-solid fa-xmark text-xl"></i></button>
      </div>
      <div class="p-6 flex-1 overflow-y-auto">
        <div class="md:hidden mb-6 pb-6 border-b border-slate-100 dark:border-slate-800 space-y-2">
           <div class="text-[10px] font-black text-slate-400 uppercase tracking-widest px-2 mb-2">Navigation</div>
           <div class="grid grid-cols-2 gap-2">
              <button onclick="switchTab('ai'); toggleDrawer()" class="col-span-2 bg-gradient-to-r from-violet-600 to-indigo-600 text-white font-bold py-2.5 rounded-lg text-xs flex items-center justify-center gap-2 shadow-sm"><i class="fa-solid fa-sparkles"></i> Open AI Analyst</button>
              <button onclick="switchTab('dash'); toggleDrawer()" class="bg-blue-50 dark:bg-blue-900/20 text-dict-blue dark:text-blue-400 font-bold py-2.5 rounded-lg text-xs flex items-center justify-center gap-2"><i class="fa-solid fa-chart-pie"></i> Dashboard</button>
              <button onclick="switchTab('map'); toggleDrawer()" class="bg-slate-50 dark:bg-slate-800 text-slate-600 dark:text-slate-300 font-bold py-2.5 rounded-lg text-xs border dark:border-slate-700 flex items-center justify-center gap-2"><i class="fa-solid fa-map"></i> Map</button>
              <button onclick="toggleTheme()" class="bg-slate-50 dark:bg-slate-800 text-slate-600 dark:text-slate-300 font-bold py-2.5 rounded-lg text-xs border dark:border-slate-700 flex items-center justify-center gap-2"><i class="fa-solid fa-circle-half-stroke"></i> Theme</button>
              <button onclick="toggleSettings(); toggleDrawer()" class="bg-slate-50 dark:bg-slate-800 text-slate-600 dark:text-slate-300 font-bold py-2.5 rounded-lg text-xs border dark:border-slate-700 flex items-center justify-center gap-2"><i class="fa-solid fa-gear"></i> Settings</button>
           </div>
        </div>
        <div class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-4 px-2">Filter by Province</div>
        <div id="sidebar-nav" class="space-y-1"></div>
        <div id="snapshotBanner" class="hidden mt-6 p-4 rounded-xl border border-orange-200 bg-orange-50 dark:bg-orange-900/20 dark:border-orange-900/40">
          <div class="flex flex-col gap-2">
            <div><div class="text-[9px] font-black uppercase tracking-widest text-orange-600 dark:text-orange-400">Snapshot</div><div id="snapshotName" class="text-xs font-bold text-orange-900 dark:text-orange-200 mt-1 truncate">—</div></div>
            <button onclick="exitSnapshotMode()" class="w-full py-1.5 rounded-lg text-[10px] font-black bg-white dark:bg-slate-800 border border-orange-200 dark:border-slate-700 hover:bg-orange-50 transition text-orange-700 dark:text-orange-300">Back to Live</button>
          </div>
        </div>
      </div>
      <div class="p-6 bg-slate-50/50 dark:bg-slate-950/50 border-t border-slate-200 dark:border-slate-700 shrink-0 space-y-2">
        <button onclick="saveSnapshot()" class="w-full bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 hover:border-dict-blue dark:hover:border-blue-500 text-slate-600 dark:text-slate-300 font-black text-xs py-3 rounded-xl shadow-sm flex items-center justify-center gap-2 transition"><i class="fa-solid fa-floppy-disk"></i> Save Report</button>
        
        <div class="grid grid-cols-2 gap-2">
            <button onclick="exportReport('csv')" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-black text-[10px] py-2.5 rounded-xl shadow flex items-center justify-center gap-1.5 transition"><i class="fa-solid fa-file-csv"></i> EXPORT CSV</button>
            <button onclick="exportReport('pdf')" class="w-full bg-red-600 hover:bg-red-700 text-white font-black text-[10px] py-2.5 rounded-xl shadow flex items-center justify-center gap-1.5 transition"><i class="fa-solid fa-file-pdf"></i> EXPORT PDF</button>
        </div>

        <button onclick="openModal('modalHistory')" class="w-full bg-slate-800 hover:bg-slate-700 text-white font-black text-xs py-3 rounded-xl shadow flex items-center justify-center gap-2 transition"><i class="fa-solid fa-clock-rotate-left"></i> History / Compare</button>
      </div>
    </aside>

    <main id="view-dash" class="view-section flex-1 bg-transparent p-4 md:p-8 overflow-y-auto pb-24">
      <div id="compareBanner" class="hidden bg-white dark:bg-slate-900 border border-orange-200 dark:border-orange-900/50 p-4 rounded-xl shadow-sm mb-6 flex flex-col md:flex-row justify-between md:items-center gap-3 relative overflow-hidden">
        <div class="absolute left-0 top-0 bottom-0 w-1 bg-orange-500"></div>
        <div class="pl-2">
          <h3 class="font-black text-sm text-slate-800 dark:text-slate-100 flex items-center gap-2"><span class="w-6 h-6 rounded-full bg-orange-100 dark:bg-orange-900 flex items-center justify-center text-orange-600"><i class="fa-solid fa-scale-balanced text-xs"></i></span> Comparison Active</h3>
          <p class="text-xs text-slate-500 mt-1" id="compareLabels"></p>
        </div>
        <div class="flex gap-2">
          <button onclick="openModal('modalCompare')" class="bg-orange-50 dark:bg-orange-900/30 border border-orange-200 dark:border-orange-800 text-xs font-black px-4 py-2 rounded-lg text-orange-700 dark:text-orange-300 transition hover:bg-orange-100">View Analytics</button>
          <button onclick="exitCompareMode()" class="bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-xs font-black px-4 py-2 rounded-lg text-slate-600 dark:text-slate-300 transition hover:bg-slate-50">Exit</button>
        </div>
      </div>

      <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
        <div class="glass-panel p-4 border-l-4 border-slate-500 group hover:scale-[1.02] transition h-full flex flex-col justify-between">
            <p class="text-[10px] font-black uppercase text-slate-400 mb-1">Total LGUs</p>
            <h2 class="text-2xl font-black text-slate-800 dark:text-white" id="kpi-total">0</h2>
        </div>
        <div class="glass-panel p-4 border-l-4 border-green-500 group hover:scale-[1.02] transition h-full">
            <p class="text-[10px] font-black uppercase text-slate-400 mb-1">Operational</p>
            <div id="kpi-op-container" class="flex items-center justify-between h-full">
                <h2 class="text-2xl font-black text-slate-800 dark:text-white">0</h2>
            </div>
        </div>
        <div class="glass-panel p-4 border-l-4 border-blue-500 group hover:scale-[1.02] transition h-full">
            <p class="text-[10px] font-black uppercase text-slate-400 mb-1">Developmental</p>
            <div id="kpi-dev-container" class="flex items-center justify-between h-full">
                 <h2 class="text-2xl font-black text-slate-800 dark:text-white">0</h2>
            </div>
        </div>
        <div class="glass-panel p-4 border-l-4 border-yellow-500 group hover:scale-[1.02] transition h-full flex flex-col justify-between">
            <p class="text-[10px] font-black uppercase text-slate-400 mb-1">With LOI</p>
            <h2 class="text-2xl font-black text-slate-800 dark:text-white" id="kpi-loi">0</h2>
        </div>
        <div class="glass-panel p-4 border-l-4 border-red-500 group hover:scale-[1.02] transition h-full flex flex-col justify-between">
            <p class="text-[10px] font-black uppercase text-slate-400 mb-1">No LOI</p>
            <h2 class="text-2xl font-black text-slate-800 dark:text-white" id="kpi-no">0</h2>
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
        <div class="glass-panel p-5 relative">
          <button class="chart-expand-btn" onclick="maximizeChart('pie')"><i class="fa-solid fa-expand"></i></button>
          <h3 class="text-xs font-black text-slate-400 uppercase mb-4">Status Overview</h3>
          <div class="h-48"><canvas id="chartPie"></canvas></div>
        </div>
        <div class="glass-panel p-5 relative">
          <button class="chart-expand-btn" onclick="maximizeChart('year')"><i class="fa-solid fa-expand"></i></button>
          <h3 class="text-xs font-black text-slate-400 uppercase mb-4">Timeline (Status Breakdown)</h3>
          <div class="h-48"><canvas id="chartYear"></canvas></div>
        </div>
        <div class="glass-panel p-5 relative">
          <button class="chart-expand-btn" onclick="maximizeChart('bar')"><i class="fa-solid fa-expand"></i></button>
          <h3 class="text-xs font-black text-slate-400 uppercase mb-4">Provincial Breakdown</h3>
          <div class="h-48"><canvas id="chartBar"></canvas></div>
        </div>
      </div>

      <div class="glass-panel flex flex-col min-h-[500px]">
        <div class="px-5 py-4 border-b border-slate-100 dark:border-slate-800 bg-white/50 dark:bg-slate-900/50 flex flex-col md:flex-row gap-3 items-center sticky top-0 z-20 rounded-t-2xl backdrop-blur-sm">
          <h3 class="font-black text-sm flex items-center gap-2"><i class="fa-solid fa-list text-slate-400"></i> Master List</h3>
          <div class="flex flex-col md:flex-row gap-2 ml-auto w-full md:w-auto">
            <select id="filterEReadiness" onchange="resetPg();applyFilters()" class="text-xs border rounded-lg px-2 py-1.5 bg-white/80 dark:bg-slate-800/80 outline-none w-full md:w-36 focus:ring-1 ring-blue-500">
              <option value="All">All e-Readiness</option><option value="Digitally ready">Digitally Ready</option><option value="Not digitally ready">Not Digitally Ready</option>
            </select>
            <select id="filterStatus" onchange="resetPg();applyFilters()" class="text-xs border rounded-lg px-2 py-1.5 bg-white/80 dark:bg-slate-800/80 outline-none w-full md:w-32 focus:ring-1 ring-blue-500">
              <option value="All">All Status</option><option value="Operational">Operational</option><option value="Developmental">Developmental</option><option value="With LOI">With LOI</option><option value="No LOI">No LOI</option>
            </select>
            <select id="filterYear" onchange="resetPg();applyFilters()" class="text-xs border rounded-lg px-2 py-1.5 bg-white/80 dark:bg-slate-800/80 outline-none w-full md:w-32 focus:ring-1 ring-blue-500"><option value="All">All Years</option></select>
            <div class="relative w-full md:w-48"><i class="fa-solid fa-search absolute left-3 top-2 text-slate-400 text-xs"></i><input type="text" id="searchBox" onkeyup="resetPg();applyFilters()" placeholder="Search LGUs..." class="pl-8 pr-4 py-1.5 bg-white/80 dark:bg-slate-800/80 border rounded-lg text-xs outline-none w-full focus:ring-1 ring-blue-500"></div>
          </div>
        </div>
        <div class="overflow-x-auto flex-1 w-full relative">
          <table class="w-full text-left text-sm border-collapse">
            <thead class="bg-slate-50/50 dark:bg-slate-900/50 text-[10px] text-slate-500 uppercase font-black border-b border-slate-100 dark:border-slate-800 sticky top-0 z-10 backdrop-blur-sm">
              <tr>
                <th class="px-6 py-4 cursor-pointer hover:bg-slate-100/50 dark:hover:bg-slate-800/50" onclick="sortData('Province')">Province <i class="fa-solid fa-sort ml-1 opacity-40"></i></th>
                <th class="px-6 py-4 cursor-pointer hover:bg-slate-100/50 dark:hover:bg-slate-800/50" onclick="sortData('Municipality')">Municipality <i class="fa-solid fa-sort ml-1 opacity-40"></i></th>
                <th class="px-6 py-4 cursor-pointer hover:bg-slate-100/50 dark:hover:bg-slate-800/50" onclick="sortData('Status')">Status <i class="fa-solid fa-sort ml-1 opacity-40"></i></th>
                <th class="px-6 py-4 cursor-pointer hover:bg-slate-100/50 dark:hover:bg-slate-800/50" onclick="sortData('EReadiness')">e-Readiness <i class="fa-solid fa-sort ml-1 opacity-40"></i></th>
                <th class="px-6 py-4">Op / Train Date</th>
                <th class="px-6 py-4">Remarks</th>
                <th class="px-6 py-4 text-right">Actions</th>
              </tr>
            </thead>
            <tbody id="tableBody" class="divide-y divide-slate-100 dark:divide-slate-800"></tbody>
          </table>
        </div>
        <div class="px-5 py-3 border-t bg-slate-50/50 dark:bg-slate-900/50 flex justify-between items-center text-xs font-black rounded-b-2xl shrink-0 backdrop-blur-sm">
          <div class="text-slate-500"><span id="pgStart">0</span>-<span id="pgEnd">0</span> of <span id="pgTotal">0</span></div>
          <div class="flex gap-2">
            <button onclick="changePg(-1)" class="px-3 py-1 rounded bg-white/80 dark:bg-slate-800/80 border shadow-sm transition hover:bg-slate-100">PREV</button>
            <button onclick="changePg(1)" class="px-3 py-1 rounded bg-white/80 dark:bg-slate-800/80 border shadow-sm transition hover:bg-slate-100">NEXT</button>
          </div>
        </div>
      </div>
    </main>

    <main id="view-map" class="view-section hidden flex-1 relative bg-transparent">
      <div id="map" class="h-full w-full"></div>
      <div class="absolute bottom-24 left-4 md:bottom-8 bg-white/90 dark:bg-slate-900/90 backdrop-blur-md p-4 rounded-xl shadow-xl z-[999] text-[10px] border dark:border-slate-700 w-auto max-w-[200px]">
        <div class="font-black mb-3 uppercase text-slate-500 tracking-widest border-b pb-2">Status Legend</div>
        <div class="grid grid-cols-1 gap-2">
           <div class="flex items-center gap-2"><span class="w-3 h-3 rounded-full" style="background:#22c55e; box-shadow: 0 0 4px #22c55e"></span> Operational</div>
           <div class="flex items-center gap-2"><span class="w-3 h-3 rounded-full" style="background:#3b82f6; box-shadow: 0 0 4px #3b82f6"></span> Developmental</div>
           <div class="flex items-center gap-2"><span class="w-3 h-3 rounded-full" style="background:#f59e0b; box-shadow: 0 0 4px #f59e0b"></span> With LOI</div>
           <div class="flex items-center gap-2"><span class="w-3 h-3 rounded-full" style="background:#ef4444; box-shadow: 0 0 4px #ef4444"></span> No LOI</div>
        </div>
      </div>
    </main>

    <main id="view-ai" class="view-section hidden flex-1 flex flex-col p-2 md:p-8 bg-transparent overflow-hidden h-full">
      <div class="max-w-4xl mx-auto w-full h-full flex flex-col">
        <div class="bg-white/90 dark:bg-slate-900/80 backdrop-blur-xl border border-slate-200 dark:border-slate-800 rounded-2xl flex-1 shadow-sm overflow-hidden flex flex-col">
            <div class="p-4 border-b bg-slate-50/50 dark:bg-slate-950/50 flex justify-between items-center">
                <div class="text-xs font-black uppercase text-slate-500 tracking-widest flex items-center gap-2">
                    <i class="fa-solid fa-robot text-indigo-500"></i> AI Data Analyst
                </div>
                <label class="flex items-center cursor-pointer gap-2">
                    <span class="text-[10px] font-bold text-slate-400 uppercase">Summarized</span>
                    <div class="relative">
                        <input type="checkbox" id="aiToggle" class="sr-only">
                        <div class="block bg-slate-200 dark:bg-slate-700 w-10 h-6 rounded-full"></div>
                        <div class="dot absolute left-1 top-1 bg-white w-4 h-4 rounded-full transition transform duration-300 ease-in-out"></div>
                    </div>
                    <span class="text-[10px] font-bold text-slate-400 uppercase">Detailed</span>
                </label>
                <style>
                    #aiToggle:checked ~ .dot { transform: translateX(100%); background-color: #6366f1; }
                    #aiToggle:checked ~ .block { background-color: #e0e7ff; }
                </style>
            </div>
            <div id="chatContainer" class="flex-1 overflow-y-auto p-4 space-y-4 bg-transparent"></div>
            
            <div class="p-4 bg-white/50 dark:bg-slate-900/50 border-t">
                <div class="flex gap-2 mb-2">
                    <button onclick="triggerAiReport()" class="text-[10px] font-bold bg-indigo-50 dark:bg-indigo-900/40 text-indigo-600 dark:text-indigo-300 px-3 py-1.5 rounded-full hover:bg-indigo-100 dark:hover:bg-indigo-800 transition flex items-center gap-1 border border-indigo-200 dark:border-indigo-700/50"><i class="fa-solid fa-wand-magic-sparkles"></i> ✨ Generate Summary Report</button>
                </div>
                <div class="flex items-center gap-3">
                    <input type="text" id="chatInput" placeholder="Ask about the data..." class="flex-1 px-4 py-3 bg-slate-100/80 dark:bg-slate-800/80 rounded-xl outline-none text-sm focus:ring-2 ring-indigo-500 transition" onkeypress="if(event.key==='Enter')sendChat()">
                    <button onclick="sendChat()" class="bg-indigo-600 text-white w-12 h-12 rounded-xl hover:bg-indigo-700 transition flex items-center justify-center shadow-lg shadow-indigo-500/20"><i class="fa-solid fa-paper-plane"></i></button>
                </div>
            </div>
        </div>
      </div>
    </main>
  </div>

  <div id="modalChart" class="fixed inset-0 z-[130] flex items-center justify-center bg-black/80 backdrop-blur-md modal p-4">
    <div class="bg-white dark:bg-slate-900 rounded-2xl shadow-2xl w-full max-w-7xl overflow-hidden flex flex-col h-[90vh] md:h-[85vh]">
      <div class="p-5 border-b dark:border-slate-800 flex justify-between items-center bg-slate-50 dark:bg-slate-950 font-black shrink-0">
          <div id="modalChartTitle" class="text-2xl text-slate-800 dark:text-white tracking-tight">Chart Analysis</div>
          <button onclick="closeModal('modalChart')"><i class="fa-solid fa-xmark text-2xl text-slate-500 hover:text-slate-800 dark:hover:text-white transition"></i></button>
      </div>
      <div class="flex-1 overflow-y-auto md:overflow-hidden flex flex-col md:flex-row">
          <div class="w-full md:w-2/3 p-4 md:p-8 bg-white dark:bg-slate-900 flex items-center justify-center border-b md:border-b-0 md:border-r border-slate-100 dark:border-slate-800 relative h-[40vh] md:h-full shrink-0">
             <div class="relative h-full w-full"><canvas id="chartModalCanvas"></canvas></div>
          </div>
          <div class="w-full md:w-1/3 p-4 md:p-8 bg-slate-50/50 dark:bg-slate-950/50 overflow-y-auto h-auto md:h-full">
             <div id="modalChartDetails" class="space-y-6"></div>
          </div>
      </div>
    </div>
  </div>

  <div id="settingsBar" class="bg-slate-800 dark:bg-slate-950 text-white p-4 hidden absolute top-0 left-0 w-full z-[200] shadow-xl border-b border-slate-700 animate-in slide-in-from-top duration-300">
    <div class="flex flex-col md:flex-row justify-center items-center gap-4 max-w-4xl mx-auto relative">
      <button onclick="toggleSettings()" class="absolute -top-1 right-0 text-slate-400 p-2 hover:text-white transition"><i class="fa-solid fa-xmark text-xl"></i></button>
      
      <div class="flex flex-col w-full md:w-auto">
        <label class="text-[9px] font-bold uppercase text-slate-400 mb-1">Apps Script URL (Backend)</label>
        <input type="text" id="apiUrl" placeholder="https://script.google.com/..." class="text-xs bg-slate-700 border border-slate-600 rounded px-4 py-2 w-full md:w-96 outline-none focus:ring-2 ring-blue-500">
      </div>

      <button onclick="saveSettings()" class="bg-dict-blue hover:bg-blue-600 text-white text-xs font-black px-6 py-2 rounded shadow transition mt-auto h-9">CONNECT</button>
    </div>
  </div>

  <div id="modalCompare" class="fixed inset-0 z-[110] flex items-center justify-center bg-slate-900/95 backdrop-blur-md modal p-4 overflow-y-auto">
      <div class="bg-slate-50 dark:bg-slate-950 rounded-3xl shadow-2xl w-full max-w-6xl max-h-[90vh] flex flex-col overflow-hidden">
        <div class="p-6 border-b bg-white dark:bg-slate-900 flex justify-between items-center sticky top-0 z-20 shrink-0">
           <div><h2 class="text-xl font-black text-slate-800 dark:text-white">Comparison Analysis</h2><p class="text-xs text-slate-400" id="cmpSubtitle">Loading...</p></div>
           <button onclick="closeModal('modalCompare')" class="w-10 h-10 rounded-full bg-slate-100 dark:bg-slate-800 text-slate-500 hover:text-slate-800 dark:hover:text-white flex items-center justify-center transition"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <div class="p-6 overflow-y-auto flex-1">
           <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
              <div class="bg-white dark:bg-slate-900 p-5 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-800"><div class="text-[10px] uppercase font-black text-slate-400 mb-2">Total Changes</div><div class="text-4xl font-black text-dict-blue dark:text-blue-400" id="cmpChangedBig">0</div></div>
              <div class="md:col-span-3 grid grid-cols-2 md:grid-cols-4 gap-4" id="cmpStatGrid"></div>
           </div>
           
           <div class="mb-8 p-5 bg-indigo-50 dark:bg-indigo-900/20 rounded-2xl border border-indigo-100 dark:border-indigo-800">
               <h4 class="text-xs font-black uppercase text-indigo-500 mb-3">Version Distribution Changes</h4>
               <div id="cmpVersionGrid" class="grid grid-cols-1 md:grid-cols-3 gap-4"></div>
           </div>

           <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
              <div class="bg-white dark:bg-slate-900 p-5 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-800 h-64 relative"><h4 class="text-xs font-black text-center mb-4 text-slate-600 dark:text-slate-300" id="cmpLabelA">Snapshot A</h4><div class="h-48"><canvas id="cmpChartA"></canvas></div></div>
              <div class="bg-white dark:bg-slate-900 p-5 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-800 h-64 relative"><h4 class="text-xs font-black text-center mb-4 text-slate-600 dark:text-slate-300" id="cmpLabelB">Snapshot B</h4><div class="h-48"><canvas id="cmpChartB"></canvas></div></div>
           </div>
           <div class="bg-white dark:bg-slate-900 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-800 overflow-hidden">
              <div class="p-4 border-b dark:border-slate-800 flex justify-between items-center bg-slate-50 dark:bg-slate-950">
                  <h3 class="font-bold text-sm text-slate-700 dark:text-slate-200">Status Changes Detected</h3>
                  <div class="flex gap-2">
                      <button onclick="viewAllChanges()" class="text-[10px] font-bold bg-slate-200 dark:bg-slate-700 border dark:border-slate-600 px-3 py-1 rounded hover:bg-slate-300 dark:hover:bg-slate-600 text-slate-700 dark:text-slate-200">VIEW FULL LIST</button>
                      <button onclick="exportChangedCSV()" class="text-[10px] font-bold bg-white dark:bg-slate-800 border dark:border-slate-700 px-3 py-1 rounded hover:bg-slate-50 dark:hover:bg-slate-700 text-slate-600 dark:text-slate-300">EXPORT CSV</button>
                  </div>
              </div>
              <div class="max-h-[300px] overflow-y-auto">
                  <table class="w-full text-left text-sm">
                      <thead class="text-[10px] uppercase text-slate-400 bg-slate-50 dark:bg-slate-950 sticky top-0 z-10 border-b dark:border-slate-800 shadow-sm">
                          <tr><th class="px-5 py-3">LGU</th><th class="px-5 py-3">Old Status</th><th class="px-5 py-3">New Status</th><th class="px-5 py-3 text-right">Action</th></tr>
                      </thead>
                      <tbody id="cmpChangedTableFull"></tbody>
                  </table>
              </div>
           </div>
        </div>
      </div>
  </div>

  <div id="modalHistory" class="fixed inset-0 z-[100] flex items-center justify-center bg-slate-900/80 backdrop-blur-sm modal p-4"><div class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl w-full max-w-2xl overflow-hidden flex flex-col max-h-[90vh]"><div class="p-5 border-b bg-slate-50 dark:bg-slate-900 flex justify-between items-center font-black text-slate-800 dark:text-white">History & Comparison <button onclick="closeModal('modalHistory')"><i class="fa-solid fa-xmark"></i></button></div><div class="p-6 overflow-y-auto"><div class="mb-6 p-4 bg-blue-50 dark:bg-blue-900/20 rounded-xl border border-blue-100 dark:border-blue-900/50"><h4 class="text-xs font-black uppercase text-blue-600 dark:text-blue-400 mb-3">Compare Snapshots</h4><div class="flex flex-col md:flex-row gap-3 items-end"><div class="flex-1 w-full"><label class="text-[10px] font-bold text-slate-400 block mb-1">Baseline (A)</label><select id="compareA" class="w-full text-xs p-2 rounded border bg-white dark:bg-slate-900 dark:border-slate-700 dark:text-white"></select></div><div class="flex-1 w-full"><label class="text-[10px] font-bold text-slate-400 block mb-1">Comparison (B)</label><select id="compareB" class="w-full text-xs p-2 rounded border bg-white dark:bg-slate-900 dark:border-slate-700 dark:text-white"></select></div><button onclick="runComparison()" class="bg-dict-blue hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-xs font-bold w-full md:w-auto mt-2 md:mt-0">COMPARE</button></div></div><h4 class="text-xs font-black uppercase text-slate-400 mb-3">Saved Snapshots</h4><table class="w-full text-left border-collapse"><tbody id="historyList" class="divide-y divide-slate-100 dark:divide-slate-800 text-sm text-slate-700 dark:text-slate-300"></tbody></table></div></div></div>
  <div id="modalDetails" class="fixed inset-0 z-[100] flex items-center justify-center bg-slate-900/80 backdrop-blur-sm modal p-4"><div class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl w-full max-w-3xl overflow-hidden flex flex-col max-h-[90vh]"><div class="bg-dict-blue p-6 flex justify-between items-start"><div><h3 id="viewTitle" class="text-2xl font-black text-white tracking-tight">...</h3><p id="viewProvince" class="text-sm text-blue-200 font-black uppercase tracking-widest"></p></div><button onclick="closeModal('modalDetails')" class="text-white/50 hover:text-white text-2xl transition"><i class="fa-solid fa-xmark"></i></button></div><div id="sectionedContent" class="p-6 overflow-y-auto"></div></div></div>
  <div id="modalEdit" class="fixed inset-0 z-[100] flex items-center justify-center bg-slate-900/80 backdrop-blur-sm modal p-4"><div class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden flex flex-col max-h-[90vh]"><div class="p-5 border-b bg-slate-50 dark:bg-slate-900 flex justify-between items-center font-black tracking-tight">Edit LGU Information<button onclick="closeModal('modalEdit')"><i class="fa-solid fa-xmark"></i></button></div><div id="editFormContainer" class="p-6 overflow-y-auto space-y-4"><div id="dynamicInputs" class="grid grid-cols-1 gap-4"></div></div><div class="p-5 border-t flex justify-end gap-3 rounded-b-2xl"><button onclick="closeModal('modalEdit')" class="px-5 py-2 text-xs font-black text-slate-500 uppercase tracking-widest hover:bg-slate-200 rounded transition">Cancel</button><button id="btnSaveLGU" onclick="saveLGU()" class="px-8 py-2 bg-dict-blue text-white rounded-lg text-xs font-black uppercase shadow-lg tracking-widest hover:bg-blue-700 transition">Save Changes</button></div></div></div>
  <div id="modalAllChanges" class="fixed inset-0 z-[115] flex items-center justify-center bg-slate-900/95 backdrop-blur-md modal p-4"><div class="bg-white dark:bg-slate-900 rounded-2xl shadow-2xl w-full max-w-7xl h-[90vh] flex flex-col overflow-hidden"><div class="p-5 border-b dark:border-slate-800 flex justify-between items-center bg-slate-50 dark:bg-slate-950"><div class="font-black text-slate-800 dark:text-white flex gap-3 items-center"><span class="text-lg">All Status Changes</span><span class="text-xs bg-red-100 text-red-600 px-2 py-1 rounded-full" id="allChangesCount">0</span></div><button onclick="closeModal('modalAllChanges')"><i class="fa-solid fa-xmark text-xl"></i></button></div><div class="flex-1 overflow-y-auto p-0"><table class="w-full text-left text-sm"><thead class="text-[10px] uppercase text-slate-500 bg-slate-100 dark:bg-slate-800 sticky top-0 z-10 border-b dark:border-slate-700"><tr><th class="px-6 py-4">LGU</th><th class="px-6 py-4">Old Status</th><th class="px-6 py-4">New Status</th><th class="px-6 py-4 text-right">Action</th></tr></thead><tbody id="allChangesBody" class="divide-y divide-slate-100 dark:divide-slate-800"></tbody></table></div></div></div>
  <div id="modalSingleDiff" class="fixed inset-0 z-[120] flex items-center justify-center bg-black/50 backdrop-blur-sm modal p-4"><div class="bg-white dark:bg-slate-900 rounded-2xl shadow-xl w-full max-w-7xl overflow-hidden"><div class="p-4 border-b dark:border-slate-800 flex justify-between items-center font-black text-slate-800 dark:text-white"><span id="singleDiffTitle">Details</span><button onclick="closeModal('modalSingleDiff')"><i class="fa-solid fa-xmark"></i></button></div><div class="max-h-[80vh] overflow-y-auto"><table class="w-full text-sm text-left table-fixed"><thead class="bg-slate-50 dark:bg-slate-900 text-[10px] uppercase font-black text-slate-500"><tr><th class="px-4 py-2 w-[15%]">Field</th><th class="px-4 py-2 w-[42.5%]">Old Value</th><th class="px-4 py-2 w-[42.5%]">New Value</th></tr></thead><tbody id="singleDiffBody"></tbody></table></div></div></div>

 <script>
    const DOWNLOAD_URL = "https://drive.google.com/drive/folders/1qA2OZqQSDru05aIzgFPhCGicESXp22u1"; 
    const CURRENT_VERSION = "1.10"; 
    
    let LIVE_DB = [], CURRENT_VIEW_DB = [], API_URL = localStorage.getItem('elgu_api_url') || '';
    let activeFilter = 'All', map = null, markers = [];
    let chartInstPie = null, chartInstBar = null, chartInstYear = null, chartModalInst = null;
    let compareState = null, snapshotMode = false;
    let curPage = 1, pgSize = 10, sortCol = 'Province', sortAsc = true;

    // ... (Dropdown options & Edit form config)
    const DROPDOWN_OPTIONS = {
       "STATUS": ['Operational', 'Developmental', 'With LOI', 'No LOI'],
       "ELGU VERSION": ['V1', 'V2', 'Both', 'own system'],
       "MOU STATUS": ['Completed', 'Transmitted to RO', 'Transmitted to CO', 'Pending', 'No Status'],
       "EREADINESS STATUS": ['Digitally ready', 'Not digitally ready'],
       "E-READINESS RESULT": ['Digitally ready', 'Not digitally ready'],
       "UAT STATUS": ['COMPLETED', 'PENDING-RO', 'PENDING-LGU', 'PENDING-LBP', 'FOR SUBMISSION OF SIGN-UP DETAILS'],
       "EGOVPAY STATUS": ['LIVE', 'FOR SETTLEMENT TESTING', 'FOR UAT', 'FOR SUBMISSION OF INTEGRATION FORM', 'FOR CREATION OF EGOVPAY ACCOUNTS', 'FOR CREATION OF ERECEIPT', 'NO CBD SUBMISSION'],
       "BOOLEAN": ["TRUE", "FALSE"]
    };
    
    const EDIT_FORM_CONFIG = {
        "LGU PROFILE": [
            { label: "ID", keys: ["id", "_uid"], type: "hidden" },
            { label: "Name", keys: ["LGU Full Name", "Name", "Municipality"], type: "locked" },
            { label: "Province", keys: ["Province"], type: "locked" },
            { label: "Region", keys: ["Region"], type: "locked" },
            { label: "Level", keys: ["Level"], type: "text" },
            { label: "Income Class", keys: ["Income Class"], type: "text" },
            { label: "Overall Status", keys: ["Overall Status", "Status"], type: "select", options: "STATUS" },
            { label: "Latitude", keys: ["Latitude", "Lat"], type: "text" },
            { label: "Longitude", keys: ["Longitude", "Longtitude", "Lng"], type: "text" },
            { label: "eLGU Version", keys: ["eLGU Version", "Version"], type: "select", options: "ELGU VERSION" }
        ],
        "eLGU ONBOARDING DOCUMENTS": [
            { label: "Letter of Intent", keys: ["LOI", "Letter of Intent"], type: "select", options: "BOOLEAN" },
            { label: "LOI Link", keys: ["LOI Link", "Letter of Intent Link"], type: "text" },
            { label: "LOI Date", keys: ["LOI Date", "Date"], type: "text" },
            { label: "eReadiness Survey", keys: ["eReadiness Survey", "e-Readiness"], type: "select", options: "BOOLEAN" },
            { label: "eReadiness Status", keys: ["eReadiness Status", "e-Readiness Result"], type: "select", options: "EREADINESS STATUS" },
            { label: "SB Resolution", keys: ["SB", "SB Resolution"], type: "select", options: "BOOLEAN" },
            { label: "SB Link", keys: ["SB Link", "SB Resolution Link"], type: "text" },
            { label: "SB Date", keys: ["SB Date", "SB Resolution Date"], type: "text" },
            { label: "MOU", keys: ["MOU", "Memorandum of Understanding"], type: "select", options: "BOOLEAN" },
            { label: "MOU Link", keys: ["MOU Link"], type: "text" },
            { label: "MOU Status", keys: ["MOU Status"], type: "select", options: "MOU STATUS" }
        ],
        "EGOVPAY ONBOARDING": [
            { label: "Client Bank Details Form", keys: ["eGovPay CBD Form", "CBD Form"], type: "select", options: "BOOLEAN" },
            { label: "CBD Link", keys: ["eGovPay CBD Link", "CBD Link"], type: "text" },
            { label: "Sign Up Details", keys: ["Sign Up Details"], type: "select", options: "BOOLEAN" },
            { label: "Sign Up Details Link", keys: ["Sign up Details Link Form", "Sign Up Link"], type: "text" },
            { label: "UAT Date", keys: ["eGovPay UAT Date", "UAT Date"], type: "text" },
            { label: "Sign Off", keys: ["eGovPay Sign Off", "Sign Off"], type: "select", options: "BOOLEAN" },
            { label: "Sign Off Link", keys: ["eGovPay Sign Off Link", "Sign Off Link"], type: "text" },
            { label: "Sign Off Date", keys: ["eGovPay Sign Off Date", "Sign Off Date"], type: "text" },
            { label: "eGovPay Status", keys: ["eGovPay Status", "egovpay_status"], type: "select", options: "EGOVPAY STATUS" },
            { label: "eGovPay Remarks", keys: ["eGovPay Remarks", "Remarks"], type: "text" }
        ],
        "ADMIN TRAINING AND SYSTEM SETUP": [
            { label: "Consent Form", keys: ["Consent Form", "Data Sharing Agreement"], type: "select", options: "BOOLEAN" },
            { label: "Consent Form Link", keys: ["Consent Form Link"], type: "text" },
            { label: "Training Start Date", keys: ["Training Start Date", "Admin Training Date"], type: "text" },
            { label: "Training End Date", keys: ["Training End Date"], type: "text" },
            { label: "Setup Checklist", keys: ["Setup Checklist", "System Setup"], type: "select", options: "BOOLEAN" },
            { label: "Setup Checklist Link", keys: ["Setup Checklist Link"], type: "text" },
            { label: "Setup Checklist Date", keys: ["Setup Checklist Date", "Setup Date"], type: "text" }
        ],
        "USER ACCEPTANCE AND TESTING": [
            { label: "Issue Logs", keys: ["Issue Logs", "Issues"], type: "select", options: "BOOLEAN" },
            { label: "Issue Logs Link", keys: ["Issue Logs Link"], type: "text" },
            { label: "Acceptance Checklist", keys: ["Acceptance Checklist"], type: "select", options: "BOOLEAN" },
            { label: "Acceptance Checklist Link", keys: ["Acceptance Checklist Link"], type: "text" },
            { label: "UAT Sign Off", keys: ["UAT Sign Off"], type: "select", options: "BOOLEAN" },
            { label: "UAT Sign Off Link", keys: ["UAT Sign Off Link"], type: "text" },
            { label: "UAT Sign Off Date", keys: ["UAT Sign Off Date"], type: "text" },
            { label: "UAT Status", keys: ["UAT Status"], type: "select", options: "UAT STATUS" },
            { label: "UAT Remarks", keys: ["UAT Remarks"], type: "text" }
        ],
        "GO LIVE PREPARATIONS": [
            { label: "Go Live Checklist", keys: ["Go Live Checklist", "Go-Live Checklist"], type: "select", options: "BOOLEAN" },
            { label: "Go Live Checklist Link", keys: ["Go Live Checklist Link"], type: "text" },
            { label: "Operational Date", keys: ["Operational Date", "Go Live Date", "Op Date"], type: "text" }
        ],
        "VERSION AND ADDITIONAL INFO": [
            { label: "V1 Operational", keys: ["V1 Operational"], type: "select", options: "BOOLEAN" },
            { label: "V2 Operational", keys: ["V2 Operational"], type: "select", options: "BOOLEAN" },
            { label: "V2 Developmental", keys: ["V2 Developmental", "V2 Developmen tal", "V2_Developmental"], type: "select", options: "BOOLEAN" },
            { label: "Personnel Incharge", keys: ["Personnel Incharge"], type: "text" },
            { label: "MOVs Drive", keys: ["MOVs Drive", "MOVs", "Means of Verification"], type: "text" }
        ],
        "OVERALL": [
            { label: "Overall Remarks", keys: ["Overall Remarks", "Remarks"], type: "text" },
        ]
    };

    window.onload = () => {
      if (localStorage.getItem('theme') === 'dark') document.documentElement.classList.add('dark');
      if (API_URL) {
        document.getElementById('apiUrl').value = API_URL;
        initData();
        checkVersion();
        setInterval(() => { if (!snapshotMode && (!compareState || document.getElementById('compareBanner').classList.contains('hidden'))) fetchLiveData(); }, 30000);
      } else toggleSettings();
    };

    function showLoading(txt = 'SYNCING DATA...') { document.getElementById('loaderText').innerText = txt; document.getElementById('loadingOverlay').classList.remove('hidden'); }
    function hideLoading() { document.getElementById('loadingOverlay').classList.add('hidden'); }
    function openModal(id) { document.getElementById(id).classList.add('active'); }
    function closeModal(id) { document.getElementById(id).classList.remove('active'); }
    function toggleDrawer() { document.getElementById('sidebar').classList.toggle('open'); document.getElementById('drawerOverlay').classList.toggle('open'); }

    async function checkVersion() { try { const res = await fetch(`${API_URL}?action=checkVersion`); const json = await res.json(); if (json.version && json.version !== CURRENT_VERSION) { document.getElementById('remoteVersionDisplay').innerText = `New: V${json.version}`; document.getElementById('forceUpdateModal').classList.remove('hidden'); } } catch(e) {} }
    async function initData() { showLoading(); const p = fetchLiveData(); const t = new Promise((r)=>setTimeout(()=>r('timeout'), 10000)); const res = await Promise.race([p, t]); if (res === 'timeout') { hideLoading(); alert("Timeout"); toggleSettings(); } else { await fetchHistoryList(); hideLoading(); } }
    
    async function fetchLiveData() { 
        try { 
            const res = await fetch(`${API_URL}?action=getLive`); 
            LIVE_DB = normalizeData(await res.json()); 
            if (document.getElementById('compareBanner').classList.contains('hidden') && !snapshotMode) { 
                if (activeFilter !== 'All') CURRENT_VIEW_DB = LIVE_DB.filter(x => x.Province === activeFilter); 
                else CURRENT_VIEW_DB = LIVE_DB; 
                renderDashboard(); 
                if (document.getElementById('view-map') && !document.getElementById('view-map').classList.contains('hidden')) { 
                    if(!map) initMap(); else renderMapMarkers(CURRENT_VIEW_DB); 
                } 
                document.getElementById('statusIndicator').classList.remove('hidden'); 
                document.getElementById('statusText').innerText = 'Live'; 
            } 
            return 'success'; 
        } catch (e) { return 'error'; } 
    }

    function normalizeData(rawData) { 
        return rawData.map(row => { 
            const keys = Object.keys(row); 
            const cleanKey = (str) => String(str).toLowerCase().replace(/[\r\n]+/g, ' ').replace(/\s+/g, ' ').trim(); 
            const find = (ks) => { const k = keys.find(x => ks.some(key => cleanKey(x) === cleanKey(key))); return k ? row[k] : ""; }; 
            return { 
                ID: row['_uid'] || find(['id', 'new geocode']), 
                Province: find(['province']), 
                Municipality: find(['name', 'municipality', 'lgu full name']), 
                Status: find(['overall status', 'status']), 
                Remarks: find(['overall remarks', 'remarks']), 
                OpDate: find(['operational date', 'go live date', 'op date', 'bg', 'operational_date']), 
                TrainDate: find(['training start date', 'admin training date']), 
                EReadiness: find(['ereadiness status', 'e-readiness result', 'e-readiness']),
                Version: find(['elgu version', 'version']), 
                Lat: row[keys[8]] || find(['latitude', 'lat']), 
                Lng: row[keys[9]] || find(['longitude', 'lng']), 
                _raw: row 
            }; 
        }).filter(x => x.Municipality); 
    }

    function renderDashboard() { renderSidebar(); updateStats(); renderCharts(); populateYearFilter(); resetPg(); applyFilters(); }
    
    function renderSidebar() { const nav = document.getElementById('sidebar-nav'); const provs = [...new Set(LIVE_DB.map(x => x.Province).filter(Boolean))].sort(); const allBtn = `<button onclick="filterProv('All')" class="sb-btn ${activeFilter === 'All' ? 'active' : ''}"><span class="flex items-center gap-2"><i class="fa-solid fa-globe opacity-70"></i> <span>All Provinces</span></span><span class="sb-pill">${LIVE_DB.length}</span></button>`; nav.innerHTML = allBtn + provs.map(p => `<button onclick="filterProv('${escapeQuotes(p)}')" class="sb-btn ${activeFilter === p ? 'active' : ''}"><span class="truncate">${p}</span><span class="sb-pill">${LIVE_DB.filter(d => d.Province === p).length}</span></button>`).join(''); }
    function escapeQuotes(s) { return String(s).replace(/'/g, "\\'"); }
    async function filterProv(p) { activeFilter = p; renderSidebar(); toggleDrawer(); CURRENT_VIEW_DB = (p === 'All') ? LIVE_DB : LIVE_DB.filter(d => d.Province === p); if (document.getElementById('view-map') && !document.getElementById('view-map').classList.contains('hidden')) { renderMapMarkers(CURRENT_VIEW_DB); if (p !== 'All' && map && markers.length > 0) { const group = new L.featureGroup(markers); map.fitBounds(group.getBounds().pad(0.1)); } else if (map) { map.setView([17.2, 121.0], 8); } } resetPg(); applyFilters(); updateStats(); renderCharts(); }

    function getStatsFrom(data) {
      let s = { op: 0, dev: 0, loi: 0, no: 0, total: data.length };
      data.forEach(r => {
        const st = (r.Status || "").toLowerCase();
        if (st.includes('operational')) s.op++;
        else if (st.includes('developmental')) s.dev++;
        else if (st.includes('no loi')) s.no++;
        else if (st.includes('with loi') || st.includes('loi')) s.loi++;
        else s.no++;
      });
      return s;
    }
    
    function getVersionStats(data, status) {
        // 1. Calculate v1ToV2 GLOBALLY so Operational LGUs still count towards this metric
        let v1ToV2 = 0;
        data.forEach(d => {
            const v1Op = String(d._raw['V1 Operational'] || '').toUpperCase() === 'TRUE';
            const v2Dev = String(d._raw['V2 Developmental'] || d._raw['V2 Developmen tal'] || '').toUpperCase() === 'TRUE';
            if (v1Op && v2Dev) {
                v1ToV2++;
            }
        });

        // 2. Filter data for the remaining specific status metrics
        let filtered = data;
        if (status) {
           filtered = data.filter(d => (d.Status||'').toLowerCase().includes(status.toLowerCase()));
        }
        
        let v1 = 0, v2 = 0, both = 0;
        
        const isOpCheck = status && status.toLowerCase() === 'operational';
        const isDevCheck = status && status.toLowerCase() === 'developmental';

        filtered.forEach(d => {
            let isV1 = false, isV2 = false;

            const v1Op = String(d._raw['V1 Operational'] || '').toUpperCase() === 'TRUE';
            const v2Op = String(d._raw['V2 Operational'] || '').toUpperCase() === 'TRUE';
            const v2Dev = String(d._raw['V2 Developmental'] || d._raw['V2 Developmen tal'] || '').toUpperCase() === 'TRUE';

            if (isOpCheck) {
                isV1 = v1Op;
                isV2 = v2Op;
            } else if (isDevCheck) {
                isV2 = v2Dev;
            } else {
                isV1 = v1Op;
                isV2 = v2Op || v2Dev;
            }

            const v = (d.Version || '').toLowerCase();

            if (isV1 && isV2) { both++; }
            else if (isV1) { v1++; }
            else if (isV2) { v2++; }
            else if (v.includes('both')) { both++; }
            else if (v.includes('v1')) { v1++; }
            else if (v.includes('v2')) { v2++; }
        });
        return { v1, v2, both, v1ToV2 };
    }

    function updateStats() { 
        const s = getStatsFrom(CURRENT_VIEW_DB); 
        
        document.getElementById(`kpi-total`).innerText = s.total;
        document.getElementById(`kpi-loi`).innerText = s.loi;
        document.getElementById(`kpi-no`).innerText = s.no;

        const opV = getVersionStats(CURRENT_VIEW_DB, 'operational');
        const devV = getVersionStats(CURRENT_VIEW_DB, 'developmental');

        document.getElementById('kpi-op-container').innerHTML = `
            <h2 class="text-2xl font-black text-slate-800 dark:text-white">${s.op}</h2>
            ${s.op > 0 ? `<div class="flex flex-col gap-1 items-end ml-2">
                ${opV.v1 > 0 ? `<span class="stat-pill text-green-700 dark:text-green-300 border-l-2 border-green-500 pl-1">Version 1: ${opV.v1}</span>` : ''}
                ${opV.v2 > 0 ? `<span class="stat-pill text-blue-700 dark:text-blue-300 border-l-2 border-blue-500 pl-1">Version 2: ${opV.v2}</span>` : ''}
                ${opV.both > 0 ? `<span class="stat-pill text-indigo-700 dark:text-indigo-300 border-l-2 border-indigo-500 pl-1">Both: ${opV.both}</span>` : ''}
            </div>` : ''}
        `;

        document.getElementById('kpi-dev-container').innerHTML = `
            <h2 class="text-2xl font-black text-slate-800 dark:text-white">${s.dev}</h2>
             ${(s.dev > 0 || devV.v1ToV2 > 0) ? `<div class="flex flex-col gap-1 items-end ml-2">
                ${devV.v1 > 0 ? `<span class="stat-pill text-green-700 dark:text-green-300 border-l-2 border-green-500 pl-1">Version 1: ${devV.v1}</span>` : ''}
                ${devV.v2 > 0 ? `<span class="stat-pill text-blue-700 dark:text-blue-300 border-l-2 border-blue-500 pl-1">Version 2: ${devV.v2}</span>` : ''}
                ${devV.both > 0 ? `<span class="stat-pill text-indigo-700 dark:text-indigo-300 border-l-2 border-indigo-500 pl-1">Both: ${devV.both}</span>` : ''}
                ${devV.v1ToV2 > 0 ? `<span class="stat-pill text-purple-700 dark:text-purple-300 border-l-2 border-purple-500 pl-1">V1 to V2: ${devV.v1ToV2}</span>` : ''}
            </div>` : ''}
        `;
        return s; 
    }

    function renderCharts() {
      const s = updateStats();
      const txt = document.documentElement.classList.contains('dark') ? '#94a3b8' : '#475569';
      const totalLGUs = CURRENT_VIEW_DB.length; 
      window.__chartConfigs = window.__chartConfigs || {};
      const standardTooltip = { callbacks: { label: function(context) { let label = context.dataset.label || ''; if (label) label += ': '; let val = context.raw; let total = context.chart._metasets[context.datasetIndex].total; if(context.chart.config.type === 'bar') { total = 0; context.chart.data.datasets.forEach(ds => total += ds.data[context.dataIndex]); } let pct = total > 0 ? ((val / total) * 100).toFixed(1) + '%' : '0%'; return `${label}${val} out of ${total} (${pct})`; } } };
      const timelineTooltip = { callbacks: { label: function(context) { let label = context.dataset.label || ''; if (label) label += ': '; let val = context.raw; let pct = totalLGUs > 0 ? ((val / totalLGUs) * 100).toFixed(1) + '%' : '0%'; return `${label}${val} out of ${totalLGUs} Total LGUs (${pct})`; } } };

      if (chartInstPie) chartInstPie.destroy();
      const cfgPie = { type: 'doughnut', data: { labels: ['Operational', 'Developmental', 'With LOI', 'No LOI'], datasets: [{ data: [s.op, s.dev, s.loi, s.no], backgroundColor: ['#22c55e', '#3b82f6', '#f59e0b', '#ef4444'], borderWidth: 0 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: true, position: 'right', labels: { color: txt, font: {size: 10} } }, tooltip: standardTooltip } } };
      chartInstPie = new Chart(document.getElementById('chartPie'), cfgPie);
      window.__chartConfigs.pie = { title: 'Status Overview', type: 'pie', config: cfgPie, useStandardTooltip: true, stats: s };

      const yearlyData = {};
      CURRENT_VIEW_DB.forEach(d => { 
          const st = (d.Status || '').toLowerCase();
          
          // Use Training Date if Developmental, otherwise Operational Date
          const targetDate = (st.includes('developmental') && d.TrainDate) ? d.TrainDate : d.OpDate;
          
          const yMatch = String(targetDate || "").match(/\d{4}/);
          if (yMatch) { 
              const y = yMatch[0];
              if(!yearlyData[y]) yearlyData[y] = { op: 0, dev: 0, loi: 0, no: 0 }; 
              if(st.includes('operational')) yearlyData[y].op++; 
              else if(st.includes('developmental')) yearlyData[y].dev++; 
              else if(st.includes('with loi') || st.includes('loi')) yearlyData[y].loi++; 
              else yearlyData[y].no++; 
          } 
      });

      const yLabels = Object.keys(yearlyData).sort();
      let accOp = 0, accDev = 0;
      const dOp = [], dDev = [], dOverall = [];
      yLabels.forEach(y => { accOp += yearlyData[y].op; accDev += yearlyData[y].dev; dOp.push(accOp); dDev.push(accDev); dOverall.push(accOp + accDev); });

      if (chartInstYear) chartInstYear.destroy();
      const cfgYear = { type: 'bar', data: { labels: yLabels, datasets: [ { label: 'Overall', data: dOverall, type: 'line', borderColor: '#4f46e5', backgroundColor: '#4f46e5', borderWidth: 2, fill: false, order: 0 }, { label: 'Operational', data: dOp, backgroundColor: '#22c55e', stack: 'Stack 0', order: 1 }, { label: 'Developmental', data: dDev, backgroundColor: '#3b82f6', stack: 'Stack 0', order: 1 } ] }, options: { responsive: true, maintainAspectRatio: false, interaction: { mode: 'index', intersect: false }, plugins: { legend: { display: true, position: 'bottom', labels: { color: txt, font: {size: 10} } }, tooltip: timelineTooltip }, scales: { x: { stacked: true, ticks: { color: txt } }, y: { stacked: true, ticks: { color: txt } } } } };
      chartInstYear = new Chart(document.getElementById('chartYear'), cfgYear);
      window.__chartConfigs.year = { title: 'Timeline Progression', type: 'year', config: cfgYear, useTotalLGUTooltip: true, yearData: {labels: yLabels, growth: dOverall, op: dOp, dev: dDev} };

      const provs = [...new Set(CURRENT_VIEW_DB.map(x => x.Province).filter(Boolean))].sort().slice(0, 30);
      const ds = { op: [], dev: [], loi: [], no: [] };
      provs.forEach(p => { const sub = CURRENT_VIEW_DB.filter(d => d.Province === p); let ls = getStatsFrom(sub); ds.op.push(ls.op); ds.dev.push(ls.dev); ds.loi.push(ls.loi); ds.no.push(ls.no); });

      if (chartInstBar) chartInstBar.destroy();
      const cfgBar = { type: 'bar', data: { labels: provs, datasets: [ { label: 'Operational', data: ds.op, backgroundColor: '#22c55e', stack: 'Stack 0' }, { label: 'Developmental', data: ds.dev, backgroundColor: '#3b82f6', stack: 'Stack 0' }, { label: 'With LOI', data: ds.loi, backgroundColor: '#f59e0b', stack: 'Stack 0' }, { label: 'No LOI', data: ds.no, backgroundColor: '#ef4444', stack: 'Stack 0' } ] }, options: { responsive: true, maintainAspectRatio: false, interaction: { mode: 'index', intersect: false }, scales: { x: { stacked: true, ticks: { color: txt, font: { size: 9 }, autoSkip: false, maxRotation: 90 } }, y: { stacked: true, ticks: { color: txt } } }, plugins: { legend: { display: false }, tooltip: standardTooltip } } };
      chartInstBar = new Chart(document.getElementById('chartBar'), cfgBar);
      window.__chartConfigs.bar = { title: 'Provincial Breakdown', type:'bar', config: cfgBar, useStandardTooltip: true, rawData: ds, labels: provs };
    }

    function maximizeChart(which) {
      const meta = (window.__chartConfigs || {})[which];
      if (!meta) return;
      document.getElementById('modalChartTitle').innerText = meta.title;
      const details = document.getElementById('modalChartDetails');
      details.innerHTML = '';
      
      if(meta.type === 'pie') {
          const s = meta.stats;
          const total = s.total || 1;
          const getPct = (v) => ((v/total)*100).toFixed(1);
          const items = [
            {l: 'Operational', v: s.op, c: 'text-green-600', bg: 'bg-green-100', ver: getVersionStats(CURRENT_VIEW_DB, 'operational')},
            {l: 'Developmental', v: s.dev, c: 'text-blue-600', bg: 'bg-blue-100', ver: getVersionStats(CURRENT_VIEW_DB, 'developmental')},
            {l: 'With LOI', v: s.loi, c: 'text-yellow-600', bg: 'bg-yellow-100', ver: null},
            {l: 'No LOI', v: s.no, c: 'text-red-600', bg: 'bg-red-100', ver: null}
          ];
          items.forEach(i => {
              let subInfo = '';
              if(i.ver && (i.ver.v1 > 0 || i.ver.v2 > 0 || i.ver.both > 0 || (i.l !== 'Operational' && i.ver.v1ToV2 > 0))) {
                  subInfo = `<div class="mt-2 pt-2 border-t border-slate-200 dark:border-slate-700 flex flex-wrap gap-2 text-xs font-bold text-slate-500">
                      ${i.ver.v1 > 0 ? `<span class="px-2 py-1 bg-white dark:bg-slate-700 rounded border">Version 1: <strong>${i.ver.v1}</strong></span>` : ''}
                      ${i.ver.v2 > 0 ? `<span class="px-2 py-1 bg-white dark:bg-slate-700 rounded border">Version 2: <strong>${i.ver.v2}</strong></span>` : ''}
                      ${i.ver.both > 0 ? `<span class="px-2 py-1 bg-white dark:bg-slate-700 rounded border">Both: <strong>${i.ver.both}</strong></span>` : ''}
                      ${i.l !== 'Operational' && i.ver.v1ToV2 > 0 ? `<span class="px-2 py-1 bg-white dark:bg-slate-700 text-purple-600 rounded border">V1 to V2: <strong>${i.ver.v1ToV2}</strong></span>` : ''}
                  </div>`;
              }
              details.innerHTML += `<div class="bg-white dark:bg-slate-800 p-4 rounded-xl border border-slate-100 dark:border-slate-700 shadow-sm"><div class="flex justify-between items-center mb-1"><span class="text-sm font-black uppercase ${i.c}">${i.l}</span><span class="px-3 py-1 rounded text-xs font-bold ${i.bg} ${i.c}">${getPct(i.v)}%</span></div><div class="text-3xl font-black text-slate-800 dark:text-white mb-1">${i.v}</div>${subInfo}</div>`;
          });
      } else if (meta.type === 'year') {
           const d = meta.yearData;
           if(d.labels.length > 0) {
              const current = d.growth[d.growth.length-1] || 0;
              const prev = d.growth[d.growth.length-2] || 0;
              const diff = current - prev;
              const pct = prev > 0 ? ((diff/prev)*100).toFixed(1) : 0;
              let tableRows = '';
              const limit = Math.max(0, d.labels.length - 5);
              for(let i = d.labels.length - 1; i >= limit; i--) {
                  tableRows += `<tr class="border-b dark:border-slate-800 last:border-0 hover:bg-slate-50 dark:hover:bg-slate-800 transition"><td class="py-4 text-base font-bold text-slate-600 dark:text-slate-300">${d.labels[i]}</td><td class="py-4 text-base font-black text-indigo-600 text-right">${d.growth[i]}</td><td class="py-4 text-sm text-green-600 text-right font-bold">Op: ${d.op[i]}</td><td class="py-4 text-sm text-blue-600 text-right font-bold">Dev: ${d.dev[i]}</td></tr>`;
              }
              details.innerHTML += `<div class="bg-indigo-50 dark:bg-indigo-900/20 p-3 rounded-xl border border-indigo-100 dark:border-indigo-800 mb-4"><div class="text-[9px] font-black uppercase text-indigo-500 mb-1">Yearly Growth</div><div class="text-xl font-black text-indigo-700 dark:text-indigo-300">+${diff}</div><div class="text-[9px] font-bold text-indigo-400">${pct}% increase</div></div><div class="bg-white dark:bg-slate-800 p-5 rounded-xl border border-slate-100 dark:border-slate-700"><h4 class="text-lg font-black uppercase text-slate-400 mb-4">Recent Years Summary</h4><table class="w-full"><thead><tr class="text-xs uppercase text-slate-400 text-left"><th class="pb-3">Year</th><th class="pb-3 text-right">Total</th><th class="pb-3 text-right" colspan="2">Breakdown</th></tr></thead><tbody>${tableRows}</tbody></table></div>`;
           }
      } else if (meta.type === 'bar') {
          const l = meta.labels;
          const r = meta.rawData;
          const zipped = l.map((prov, i) => ({p: prov, op: r.op[i], dev: r.dev[i], loi: r.loi[i], no: r.no[i], total: r.op[i]+r.dev[i]+r.loi[i]+r.no[i] })).sort((a,b) => b.op - a.op);
          const top5 = zipped.slice(0, 10);
          
          details.innerHTML += `<div class="bg-white dark:bg-slate-800 p-5 rounded-xl border border-slate-100 dark:border-slate-700"><h4 class="text-sm font-black uppercase text-slate-400 mb-4">Top Provinces (Breakdown)</h4>${top5.map((x, i) => {
                const provData = CURRENT_VIEW_DB.filter(d => d.Province === x.p);
                const vStats = getVersionStats(provData, 'operational');
                const pct = x.total > 0 ? ((x.op / x.total) * 100).toFixed(1) : 0;
                
                return `<div class="py-4 border-b last:border-0 border-slate-50 dark:border-slate-800">
                <div class="flex justify-between items-center mb-2"><span class="text-base font-bold text-slate-700 dark:text-slate-300"><span class="mr-3 text-slate-400 text-xs w-4 inline-block">#${i+1}</span>${x.p}</span><span class="font-black text-lg text-slate-800 dark:text-white">${x.op} <span class="text-xs font-normal text-slate-400">of ${x.total} Operational (${pct}%)</span></span></div>
                <div class="grid grid-cols-4 gap-2 mb-2">
                    <div class="text-center bg-green-50 dark:bg-green-900/20 rounded py-1"><div class="text-[9px] text-green-500 font-bold">OP</div><div class="text-xs font-black text-green-600">${x.op}</div></div>
                    <div class="text-center bg-blue-50 dark:bg-blue-900/20 rounded py-1"><div class="text-[9px] text-blue-400 font-bold">DEV</div><div class="text-xs font-black text-blue-600">${x.dev}</div></div>
                    <div class="text-center bg-yellow-50 dark:bg-yellow-900/20 rounded py-1"><div class="text-[9px] text-yellow-500 font-bold">LOI</div><div class="text-xs font-black text-yellow-600">${x.loi}</div></div>
                    <div class="text-center bg-red-50 dark:bg-red-900/20 rounded py-1"><div class="text-[9px] text-red-400 font-bold">NONE</div><div class="text-xs font-black text-red-600">${x.no}</div></div>
                </div>
                ${x.op > 0 ? `<div class="flex justify-end gap-3 text-xs font-bold text-slate-400 mt-1 border-t border-dashed border-slate-100 pt-2">
                    ${vStats.v1 > 0 ? `<span class="text-slate-500">Version 1: <b class="text-slate-800 dark:text-white">${vStats.v1}</b></span><span class="text-slate-300">|</span>` : ''}
                    ${vStats.v2 > 0 ? `<span class="text-slate-500">Version 2: <b class="text-slate-800 dark:text-white">${vStats.v2}</b></span><span class="text-slate-300">|</span>` : ''}
                    ${vStats.both > 0 ? `<span class="text-slate-500">Both: <b class="text-slate-800 dark:text-white">${vStats.both}</b></span>` : ''}
                </div>` : ''}
            </div>`}).join('')}</div>`;
      }

      openModal('modalChart');
      setTimeout(() => {
        if (chartModalInst) chartModalInst.destroy();
        const deep = JSON.parse(JSON.stringify(meta.config));
        
        // --- CUSTOM TOOLTIP LOGIC FOR "1 of 2" AND PERCENTAGE ---
        deep.options.plugins.tooltip = {
            callbacks: {
                label: function(context) {
                    let label = context.dataset.label || '';
                    if (label && context.chart.config.type !== 'pie' && context.chart.config.type !== 'doughnut') {
                        label += ': ';
                    }
                    
                    let value = context.raw;
                    let total = 0;
                    
                    if (context.chart.config.type === 'pie' || context.chart.config.type === 'doughnut') {
                        total = context.chart._metasets[context.datasetIndex].total;
                    } else {
                         // Sum for this specific dataset stack if bar
                         const dataArr = context.chart.data.datasets[context.datasetIndex].data;
                         total = dataArr.reduce((a, b) => a + b, 0); 
                    }
                    
                    let pct = total > 0 ? ((value / total) * 100).toFixed(1) + '%' : '0%';
                    // Format: "Label: Value of Total (Percentage)"
                    return `${label}${value} of ${total} (${pct})`;
                }
            }
        };

        deep.options.plugins.legend = { display: true, position: 'bottom', labels: { font: { size: 16, weight: 'bold' }, color: document.documentElement.classList.contains('dark') ? '#cbd5e1' : '#334155', padding: 20 } };
        if(!deep.options.scales) deep.options.scales = {};
        if(deep.options.scales.x) deep.options.scales.x.ticks.font = { size: 14, weight: 'bold' };
        if(deep.options.scales.y) deep.options.scales.y.ticks.font = { size: 14, weight: 'bold' };
        // Ensure chart maintains aspect ratio in the new flex container, or fill it
        deep.options.maintainAspectRatio = false;
        
        chartModalInst = new Chart(document.getElementById('chartModalCanvas'), deep);
      }, 50);
    }

    function resetPg() { curPage = 1; }
    
    function applyFilters() { 
        const txt = document.getElementById('searchBox').value.toLowerCase(); 
        const status = document.getElementById('filterStatus').value; 
        const year = document.getElementById('filterYear').value; 
        const eread = document.getElementById('filterEReadiness').value;
        
        let data = CURRENT_VIEW_DB; 
        
        if (txt) data = data.filter(d => JSON.stringify(d).toLowerCase().includes(txt)); 
        if (status !== 'All') data = data.filter(d => (d.Status || "").includes(status)); 
        
        if (eread !== 'All') {
            const isNot = eread.toLowerCase().includes('not');
            data = data.filter(d => {
                const val = (d.EReadiness || "").toLowerCase();
                return isNot ? val.includes('not') : (val.includes('ready') && !val.includes('not'));
            });
        }

        if (year !== 'All') {
            data = data.filter(d => {
                const st = (d.Status || "").toLowerCase();
                const targetDate = (st.includes('developmental') && d.TrainDate) ? d.TrainDate : d.OpDate;
                return (targetDate || "").includes(year);
            });
        }
        
        data.sort((a, b) => { let va = String(a[sortCol] || ''), vb = String(b[sortCol] || ''); return sortAsc ? va.localeCompare(vb) : vb.localeCompare(va); }); 
        
        const total = data.length; 
        const maxPage = Math.max(1, Math.ceil(total / pgSize)); 
        if (curPage > maxPage) curPage = maxPage; 
        
        const start = (curPage - 1) * pgSize; 
        const end = Math.min(start + pgSize, total); 
        
        document.getElementById('pgStart').innerText = total ? start + 1 : 0; 
        document.getElementById('pgEnd').innerText = end; 
        document.getElementById('pgTotal').innerText = total; 
        renderTable(data.slice(start, end)); 
    }
    
    function renderTable(data) { 
        const tbody = document.getElementById('tableBody'); 
        tbody.innerHTML = ''; 
        
        data.forEach((row) => { 
            const c = statusColor(row.Status); 
            const gIdx = LIVE_DB.findIndex(x => x.ID === row.ID); 
            
            const st = (row.Status || '').toLowerCase();
            const displayDate = (st.includes('developmental') && row.TrainDate) ? row.TrainDate : (row.OpDate || '-');

            const eReadVal = (row.EReadiness || '').toLowerCase();
            const eReadC = eReadVal.includes('not') ? '#ef4444' : (eReadVal.includes('ready') ? '#22c55e' : '#94a3b8');
            const eReadHTML = row.EReadiness ? `<span class="badge" style="background:${eReadC}20; color:${eReadC}">${row.EReadiness}</span>` : '-';

            tbody.innerHTML += `<tr class="hover:bg-slate-50/50 dark:hover:bg-slate-800/50 transition border-b border-slate-50 dark:border-slate-800/50"><td class="px-6 py-4 font-black text-slate-400 text-[10px] uppercase">${row.Province || '-'}</td><td class="px-6 py-4 font-bold text-slate-800 dark:text-slate-200 text-xs">${row.Municipality}</td><td class="px-6 py-4"><span class="badge" style="background:${c}20; color:${c}">${row.Status || '-'}</span></td><td class="px-6 py-4">${eReadHTML}</td><td class="px-6 py-4 text-xs font-mono text-slate-500">${displayDate}</td><td class="px-6 py-4 text-[10px] text-slate-400 truncate max-w-[150px]">${row.Remarks || '-'}</td><td class="px-6 py-4 text-right flex justify-end gap-2"><button onclick="openViewModal(${gIdx})" class="text-[10px] font-black text-slate-500 border border-slate-200 px-3 py-1.5 rounded-lg hover:text-dict-blue uppercase tracking-tighter transition">View</button><button onclick="openEditModal(${gIdx})" class="text-[10px] font-black text-white bg-dict-blue px-3 py-1.5 rounded-lg shadow-sm hover:bg-blue-700 uppercase tracking-tighter transition">Edit</button></td></tr>`; 
        }); 
    }

    function initMap() { if (document.getElementById('view-map').classList.contains('hidden')) return; if (map) map.remove(); map = L.map('map').setView([17.2, 121.0], 8); L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map); renderMapMarkers(CURRENT_VIEW_DB); }
    function statusColor(status) { const s = (status || '').toLowerCase(); if (s.includes('operational')) return '#22c55e'; if (s.includes('developmental')) return '#3b82f6'; if (s.includes('no loi')) return '#ef4444'; if (s.includes('with loi') || s.includes('loi')) return '#f59e0b'; return '#ef4444'; }
    function renderMapMarkers(data) { if (!map) return; markers.forEach(m => map.removeLayer(m)); markers = []; data.forEach(d => { const lat = parseFloat(d.Lat); const lng = parseFloat(d.Lng); if (!isFinite(lat) || !isFinite(lng)) return; const c = statusColor(d.Status); const popup = `<div style="min-width:180px"><div style="font-weight:900">${d.Municipality}</div><div style="font-size:12px; opacity:.85">${d.Province || '-'}</div><div style="margin-top:6px; font-size:12px"><span style="display:inline-block;width:8px;height:8px;border-radius:999px;background:${c};margin-right:6px"></span><b>${d.Status || '-'}</b></div><div style="margin-top:4px; font-size:10px; color:#666; font-style:italic; border-top:1px solid #eee; padding-top:4px">${d.Remarks || 'No remarks'}</div></div>`; markers.push(L.circleMarker([lat, lng], { radius: 6, fillColor: c, color: '#fff', weight: 1, fillOpacity: 0.9 }).bindPopup(popup).addTo(map)); }); }

    // DOWNLOAD DOC FUNCTION
    function downloadDoc(content) {
        const header = "<html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'><head><meta charset='utf-8'><title>Report</title><style>body{font-family:Arial} table{border-collapse:collapse;width:100%} td,th{border:1px solid #999;padding:8px;text-align:left}</style></head><body>";
        const footer = "</body></html>";
        const sourceHTML = header + content + footer;
        const source = 'data:application/vnd.ms-word;charset=utf-8,' + encodeURIComponent(sourceHTML);
        const fileDownload = document.createElement("a");
        document.body.appendChild(fileDownload);
        fileDownload.href = source;
        fileDownload.download = 'AI_Report.doc';
        fileDownload.click();
        document.body.removeChild(fileDownload);
    }

    function setChatQuery(q) { document.getElementById('chatInput').value = q; sendChat(); }

    async function sendChat() {
      const i = document.getElementById('chatInput'); const txt = i.value.trim(); if (!txt) return;
      const isDetailed = document.getElementById('aiToggle').checked; // Capture toggle state
      const c = document.getElementById('chatContainer');
      const userDiv = document.createElement('div'); userDiv.className = "user-msg chat-bubble self-end animate-slide-in"; userDiv.innerText = txt; c.appendChild(userDiv); i.value = '';
      
      const loader = document.createElement('div'); loader.className = "ai-msg chat-bubble"; loader.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin mr-2"></i> Thinking...'; c.appendChild(loader); c.scrollTop = c.scrollHeight;
      
      const csvData = LIVE_DB.map(d => `${d.Municipality}|${d.Province}|${d.Status}|${d.Version}|${d.Remarks}`).join('\n');
      const systemInstruction = isDetailed 
        ? "You are a detailed Data Auditor. 1) If asking for specific conditions (e.g., 'training'), ONLY list rows matching that condition. 2) Provide summary explanation sentences for every table you generate. 3) Show remarks. 4) Output in clean HTML Tables with headers."
        : "You are an Executive Assistant. Provide high-level summaries. Output in clean HTML Tables where appropriate.";

      const context = `${systemInstruction}\nData Format: Municipality|Province|Status|Version|Remarks\n--- START DATA ---\n${csvData}\n--- END DATA ---\nUser Question: "${txt}"`;

      try {
          // Send isDetailed flag to backend
          const res = await fetch(API_URL, { 
              method: 'POST', 
              body: JSON.stringify({ 
                  action: 'askAI', 
                  prompt: context,
                  isDetailed: isDetailed // <--- Sending Toggle State
              }) 
          });
          const json = await res.json();
          loader.remove(); 
          const rawHtml = marked.parse(json.answer || "No response.");
          const aiDiv = document.createElement('div'); aiDiv.className = "ai-msg chat-bubble animate-slide-in relative group"; 
          aiDiv.innerHTML = rawHtml + `<button onclick="downloadDoc(this.parentNode.innerHTML.split('<button')[0])" class="absolute top-2 right-2 text-slate-400 hover:text-blue-600 opacity-0 group-hover:opacity-100 transition" title="Download as Word"><i class="fa-solid fa-file-word"></i></button>`; 
          c.appendChild(aiDiv);
      } catch(err) { loader.remove(); }
      c.scrollTop = c.scrollHeight;
    }

    function populateYearFilter() { 
        const years = new Set(); 
        CURRENT_VIEW_DB.forEach(d => { 
            const st = (d.Status || '').toLowerCase();
            const targetDate = (st.includes('developmental') && d.TrainDate) ? d.TrainDate : d.OpDate;

            if (targetDate) { 
                const y = targetDate.match(/\d{4}/); 
                if (y) years.add(y[0]); 
            } 
        }); 
        document.getElementById('filterYear').innerHTML = '<option value="All">All Years</option>' + [...years].sort().map(y => `<option value="${y}">${y}</option>`).join(''); 
    }

    function findValueInRow(raw, keysArray) { if (!keysArray || !keysArray.length) return { key: null, value: "" }; const rawKeys = Object.keys(raw); const cleanKey = (str) => String(str).toLowerCase().replace(/[\r\n]+/g, ' ').replace(/\s+/g, ' ').trim(); for (const potentialKey of keysArray) { const foundKey = rawKeys.find(k => cleanKey(k) === cleanKey(potentialKey)); if (foundKey) return { key: foundKey, value: raw[foundKey] }; } return { key: null, value: "" }; }
    
    function openViewModal(idx) { 
        const d = LIVE_DB[idx]; 
        if (!d) return; 
        
        // MOVs Drive is now assigned to its own dedicated section to make it stand out
        const viewSections = { 
            "LGU Profile": ["PROVINCE", "REGION", "LEVEL", "INCOME CLASS", "Latitude", "Longtitude", "eLGU Version", "Date"], 
            "eLGU Onboarding Documents": ["Letter of Intent", "LOI Date", "E-READINESS SURVEY", "eReadiness Status", "SB Resolution", "SB Date", "Memorandum of Understanding", "MOU Status"], 
            "eGovPay Onboarding": ["Sign Up Details", "eGovPay UAT Date", "eGovPay Sign Off", "eGovPay Sign Off Date", "eGovPay Status", "eGovPay Remarks"], 
            "Admin Training and System Setup": ["Consent Form", "Training Start Date", "Training End Date", "Setup Checklist", "SET UP Date"], 
            "User Acceptance and Testing": ["Issue Logs", "Acceptance Checklist", "UAT Sign Off", "UAT Date", "UAT Status", "UAT Remarks"], 
            "Go Live Preparations": ["Go Live Checklist", "OPERATIONAL DATE"],
            "Version Data & Personnel": ["V1 Operational", "V2 Operational", "V2 Developmental", "Personnel Incharge"],
            "Means of Verification (MOVs)": [] // Empty array prevents text rendering, routing it only to the attachment block
        }; 
        
        // This ensures the button attachment is triggered for the new MOVs section
        const attachmentMap = { 
            "LGU Profile": ["FOLDER LINK"], 
            "eLGU Onboarding Documents": ["LOI LINK", "SB LINK", "MOU LINK", "E-READINESS SURVERY LINK", "E-READINESS SURVEY LINK"], 
            "eGovPay Onboarding": ["EGOVPAY CBD LINK", "EGOVPAY SIGN OFF LINK"], 
            "Admin Training and System Setup": ["CONSENT FORM Link", "SETUP CHECKLIST Link"], 
            "User Acceptance and Testing": ["ISSUE LOGS Link", "ACCEPTANCE CHECKLIST Link", "UAT SIGN OFF Link"], 
            "Go Live Preparations": ["Go Live Checklist Link"],
            "Version Data & Personnel": [],
            "Means of Verification (MOVs)": ["MOVs Drive"]
        }; 
        
        const versionObj = findValueInRow(d._raw, ["eLGU Version", "Version"]); 
        const version = versionObj.value || ''; 
        document.getElementById('viewTitle').innerText = d.Municipality; 
        document.getElementById('viewProvince').innerHTML = `<div class="mb-2 text-sm font-black uppercase tracking-widest text-blue-200">${d.Province || '-'}</div><div class="flex items-center gap-2"><div class="inline-block px-3 py-1 rounded-md text-[10px] font-bold bg-white/10 text-white border border-white/20 shadow-sm backdrop-blur-sm">${d.Status || 'Unknown Status'}</div>${version ? `<div class="inline-block px-3 py-1 rounded-md text-[10px] font-bold bg-blue-400/40 text-white border border-white/20 shadow-sm backdrop-blur-sm">${version}</div>` : ''}</div>`; 
        const cont = document.getElementById('sectionedContent'); 
        cont.innerHTML = ""; 
        const remKey = Object.keys(d._raw).find(x => x.toLowerCase().includes('overall remarks')); 
        const remVal = remKey ? d._raw[remKey] : ''; 
        if(remVal && remVal !== '-') { cont.innerHTML += `<div class="mb-6 bg-blue-50 dark:bg-blue-900/20 border border-blue-100 dark:border-blue-800 p-4 rounded-xl"><div class="text-[10px] font-black text-blue-500 uppercase tracking-widest mb-2"><i class="fa-regular fa-comment-dots mr-2"></i>Overall Remarks</div><div class="text-sm font-medium text-slate-700 dark:text-slate-200 leading-relaxed">${remVal}</div></div>`; } 
        
        for (const [sec, fields] of Object.entries(viewSections)) { 
            let html = `<div class="section-header">${sec}</div><div class="grid grid-cols-2 gap-x-6 gap-y-4 mb-2">`; 
            fields.forEach(f => { 
                let val = '-'; 
                let configEntry = null; 
                for (const section of Object.values(EDIT_FORM_CONFIG)) { 
                    const entry = section.find(item => item.label === f || item.keys.includes(f)); 
                    if(entry) { configEntry = entry; break; } 
                } 
                if(configEntry) { 
                    val = findValueInRow(d._raw, configEntry.keys).value || '-'; 
                } else { 
                    const k = Object.keys(d._raw).find(rk => rk.toLowerCase().includes(f.toLowerCase()) || f.toLowerCase().includes(rk.toLowerCase())); 
                    val = k ? d._raw[k] : '-'; 
                } 
                const labelClass = "text-[10px] font-bold text-slate-400 block uppercase mb-1"; 
                html += `<div><span class="${labelClass}">${f}</span><span class="text-xs font-semibold dark:text-white break-words">${val}</span></div>`; 
            }); 
            html += `</div>`; 
            
            const targetLinks = attachmentMap[sec] || []; 
            const foundLinks = []; 
            targetLinks.forEach(linkKey => { 
                const foundKey = Object.keys(d._raw).find(k => k.toLowerCase().includes(linkKey.toLowerCase()) || (linkKey === "MOVs Drive" && k.toLowerCase().includes("mov"))); 
                let url = ''; 
                if(foundKey) { 
                    url = d._raw[foundKey]; 
                } 
                const isValid = url && String(url).toLowerCase().startsWith('http'); 
                foundLinks.push({ label: linkKey, url: url, valid: isValid }); 
            }); 
            if (foundLinks.length > 0) { 
                html += `<div class="mb-5 mt-2 bg-slate-50 dark:bg-slate-900/50 p-3 rounded-lg border border-slate-100 dark:border-slate-800"><div class="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-2">Attachments</div><div class="grid grid-cols-2 md:grid-cols-3 gap-2">`; 
                foundLinks.forEach(link => { 
                    if (link.valid) { 
                        html += `<a href="${link.url}" target="_blank" class="flex flex-col items-center justify-center p-2 bg-white dark:bg-slate-800 border dark:border-slate-700 rounded-lg hover:border-dict-blue transition group"><i class="fa-solid fa-paperclip text-slate-300 group-hover:text-dict-blue mb-1"></i><span class="text-[9px] font-bold uppercase text-center text-slate-500 group-hover:text-dict-blue truncate w-full">${link.label}</span></a>`; 
                    } else { 
                        html += `<div class="flex flex-col items-center justify-center p-2 bg-red-50/50 dark:bg-red-900/10 border border-red-300 dark:border-red-800/50 rounded-lg cursor-not-allowed opacity-75"><i class="fa-solid fa-file-circle-xmark text-red-400 mb-1"></i><span class="text-[9px] font-bold uppercase text-center text-red-400 truncate w-full">${link.label}</span><span class="text-[8px] font-bold text-red-300 uppercase tracking-wider mt-0.5">No File</span></div>`; 
                    } 
                }); 
                html += `</div></div>`; 
            } else { 
                html += `<div class="mb-5"></div>`; 
            } 
            cont.innerHTML += html; 
        } 
        openModal('modalDetails'); 
    }

    function openEditModal(idx) { const d = LIVE_DB[idx]; if (!d) return; const cont = document.getElementById('dynamicInputs'); cont.innerHTML = `<input type="hidden" id="editIdLock" value="${d.ID}">`; for (const [sectionName, fields] of Object.entries(EDIT_FORM_CONFIG)) { let sectionHtml = `<div class="font-black text-xs text-slate-800 dark:text-white mt-6 mb-3 pb-1 border-b-2 border-slate-100 dark:border-slate-800 sticky top-0 bg-white dark:bg-slate-800 z-10 pt-2">${sectionName}</div><div class="grid grid-cols-1 gap-3">`; fields.forEach(fieldConfig => { if (fieldConfig.type === "hidden") return; const { key: actualKey, value: actualValue } = findValueInRow(d._raw, fieldConfig.keys); const targetKey = actualKey || fieldConfig.keys[0]; const safeVal = String(actualValue || "").trim(); let inputHtml = ""; const isDate = fieldConfig.label.includes("Date") || fieldConfig.type === "date"; if (fieldConfig.type === "locked") { inputHtml = `<input type="text" data-key="${targetKey}" value="${safeVal}" readonly class="w-full text-xs font-bold border border-slate-200 dark:border-slate-700 rounded-lg px-3 py-2 bg-slate-100 dark:bg-slate-900/50 text-slate-500 cursor-not-allowed opacity-75">`; } else if (fieldConfig.type === "select") { const optionsKey = fieldConfig.options; const optionsList = DROPDOWN_OPTIONS[optionsKey] || []; const optionsHtml = optionsList.map(opt => `<option value="${opt}" ${safeVal.toUpperCase() === opt.toUpperCase() ? 'selected' : ''}>${opt}</option>`).join(''); inputHtml = `<select data-key="${targetKey}" class="w-full text-xs border rounded-lg px-3 py-2 bg-white dark:bg-slate-800 outline-none focus:ring-2 ring-blue-500">${optionsHtml}</select>`; } else if (isDate) { let dateVal = safeVal; const dateObj = new Date(safeVal); if (safeVal && safeVal.length > 5 && !isNaN(dateObj.getTime())) { try { const offset = dateObj.getTimezoneOffset() * 60000; const localISODate = new Date(dateObj.getTime() - offset).toISOString().split('T')[0]; dateVal = localISODate; } catch(e){} } inputHtml = `<input type="date" data-key="${targetKey}" value="${dateVal}" class="w-full text-xs border rounded-lg px-3 py-2 bg-white dark:bg-slate-800 outline-none focus:ring-2 ring-blue-500 text-slate-600">`; } else { inputHtml = `<input type="text" data-key="${targetKey}" value="${safeVal}" class="w-full text-xs border rounded-lg px-3 py-2 bg-white dark:bg-slate-800 outline-none focus:ring-2 ring-blue-500">`; } sectionHtml += `<div><label class="block text-[10px] font-black text-slate-500 uppercase mb-1">${fieldConfig.label}</label>${inputHtml}</div>`; }); sectionHtml += `</div>`; cont.innerHTML += sectionHtml; } openModal('modalEdit'); }
    function saveSettings() { localStorage.setItem('elgu_api_url', document.getElementById('apiUrl').value.trim()); location.reload(); }
    async function saveLGU() { const btn = document.getElementById('btnSaveLGU'); btn.innerText = 'SAVING...'; const updates = {}; const inputs = document.querySelectorAll('#dynamicInputs [data-key]'); inputs.forEach(i => { updates[i.getAttribute('data-key')] = i.value; }); const idInput = document.querySelector('#dynamicInputs input[type="hidden"]'); const id = idInput ? idInput.value : null; if(!id) { alert('Error: Record ID missing. Please reload.'); btn.innerText = 'Save Changes'; return; } const idx = LIVE_DB.findIndex(x => x.ID === id); if (idx !== -1) { Object.keys(updates).forEach(k => { LIVE_DB[idx]._raw[k] = updates[k]; }); const newNorm = normalizeData([LIVE_DB[idx]._raw])[0]; LIVE_DB[idx] = newNorm; } try { await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'updateLGU', id: id, updates: updates }) }); alert('Saved Successfully!'); } catch (e) { alert('Saved (Offline Simulation)'); } closeModal('modalEdit'); applyFilters(); updateStats(); renderCharts(); btn.innerText = 'Save Changes'; }
    function fetchHistoryList() { return fetch(`${API_URL}?action=getHistoryDates`).then(r => r.json()).then(l => { const opts = l.map(i => `<option value="${i.name}">${i.name}</option>`).join(''); ['compareA', 'compareB'].forEach(id => { document.getElementById(id).innerHTML = `<option value="live">Live Data</option>` + opts; }); document.getElementById('historyList').innerHTML = l.map(i => `<tr><td class="p-3 font-black">${i.name}</td><td class="p-3 text-slate-400 font-mono text-[10px]">${i.timestamp || ''}</td><td class="p-3 text-right"><button onclick="loadSnapshot('${escapeQuotes(i.name)}')" class="px-3 py-1.5 rounded-lg bg-white dark:bg-slate-800 border text-[10px] font-black hover:bg-slate-50 dark:hover:bg-slate-700 transition">Load</button></td></tr>`).join(''); }).catch(e => console.error("History fetch error:", e)); }
    async function loadSnapshot(name) { try { showLoading(`Loading ${name}...`); closeModal('modalHistory'); const raw = await (await fetch(`${API_URL}?action=getHistoryData&date=${encodeURIComponent(name)}`)).json(); snapshotMode = true; compareState = null; document.getElementById('compareBanner').classList.add('hidden'); CURRENT_VIEW_DB = normalizeData(raw); renderDashboard(); if (document.getElementById('view-map') && !document.getElementById('view-map').classList.contains('hidden')) { if (!map) initMap(); else renderMapMarkers(CURRENT_VIEW_DB); } document.getElementById('statusIndicator').classList.remove('hidden'); document.getElementById('statusText').innerText = 'Snapshot'; document.getElementById('snapshotBanner').classList.remove('hidden'); document.getElementById('snapshotName').innerText = name; hideLoading(); } catch (e) { hideLoading(); alert('Failed to load snapshot.'); } }
    function exitSnapshotMode() { snapshotMode = false; document.getElementById('snapshotBanner').classList.add('hidden'); CURRENT_VIEW_DB = LIVE_DB; renderDashboard(); if (document.getElementById('view-map') && !document.getElementById('view-map').classList.contains('hidden')) { if (!map) initMap(); else renderMapMarkers(CURRENT_VIEW_DB); } document.getElementById('statusText').innerText = 'Live'; }
    async function saveSnapshot() { const n = prompt("Report Name:"); if (!n) return; showLoading('Saving Snapshot...'); await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'saveSnapshot', reportName: n, data: LIVE_DB.map(d => d._raw) }) }); hideLoading(); fetchHistoryList(); }
    function exportChangedCSV() { if (!compareState || !compareState.changedRows.length) return alert('No changes.'); const rows = compareState.changedRows; const csv = ['Municipality,Province,Old Status,New Status', ...rows.map(r => [r.Municipality, r.Province, r.oldStatus, r.newStatus].map(v => `"${String(v||'').replace(/"/g,'""')}"`).join(','))].join('\n'); const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv' })); a.download = `diff_${compareState.A}_vs_${compareState.B}.csv`; a.click(); }
    
    async function runComparison() {
      const A = document.getElementById('compareA').value; const B = document.getElementById('compareB').value;
      closeModal('modalHistory'); showLoading('Comparing...');
      const getD = async (v) => v === 'live' ? LIVE_DB : normalizeData(await (await fetch(`${API_URL}?action=getHistoryData&date=${encodeURIComponent(v)}`)).json());
      const dA = await getD(A); const dB = await getD(B);
      const mapA = new Map(dA.map(x => [x.Municipality, x]));
      const changed = [];
      dB.forEach(nb => {
        const oa = mapA.get(nb.Municipality); if (!oa) return;
        const s1 = (oa.Status||'').trim();
        const s2 = (nb.Status||'').trim();
        if (s1 !== s2) {
             const allKeys = [...new Set([...Object.keys(oa._raw), ...Object.keys(nb._raw)])];
             const diffs = [];
             allKeys.forEach(k => {
                 if(k.startsWith('_')) return;
                 const v1 = String(oa._raw[k] || '').trim();
                 const v2 = String(nb._raw[k] || '').trim();
                 if(v1 !== v2) diffs.push({ key: k, old: v1, new: v2 });
             });
             changed.push({ Municipality: nb.Municipality, Province: nb.Province, oldStatus: s1, newStatus: s2, diffs: diffs });
        }
      });
      const vA = getVersionStats(dA, 'operational');
      const vB = getVersionStats(dB, 'operational');
      compareState = { A, B, statsA: getStatsFrom(dA), statsB: getStatsFrom(dB), changedRows: changed, versions: {a: vA, b: vB} };
      
      document.getElementById('compareBanner').classList.remove('hidden'); document.getElementById('compareLabels').innerText = `${A} vs ${B}`;
      renderCompareModal(); openModal('modalCompare'); CURRENT_VIEW_DB = dB; renderDashboard(); 
      if (document.getElementById('view-map') && !document.getElementById('view-map').classList.contains('hidden')) { if (!map) initMap(); else renderMapMarkers(CURRENT_VIEW_DB); }
      hideLoading();
    }

    function renderCompareModal() {
      if (!compareState) return;
      document.getElementById('cmpLabelA').innerText = compareState.A; document.getElementById('cmpLabelB').innerText = compareState.B;
      document.getElementById('cmpChangedBig').innerText = compareState.changedRows.length;
      document.getElementById('cmpSubtitle').innerText = `${compareState.A} vs ${compareState.B}`;
      const keys = [{k:'op', l:'Operational', c:'green'}, {k:'dev', l:'Developmental', c:'blue'}, {k:'loi', l:'With LOI', c:'yellow'}, {k:'no', l:'No LOI', c:'red'}];
      const htmlStats = keys.map(i => {
         const v1 = compareState.statsA[i.k]; const v2 = compareState.statsB[i.k];
         const diff = v2 - v1;
         const icon = diff > 0 ? '<i class="fa-solid fa-arrow-up"></i>' : (diff < 0 ? '<i class="fa-solid fa-arrow-down"></i>' : '<i class="fa-solid fa-minus"></i>');
         const color = diff > 0 ? 'text-green-500' : (diff < 0 ? 'text-red-500' : 'text-slate-400');
         return `<div class="bg-white dark:bg-slate-800 p-3 rounded-xl border border-slate-100 dark:border-slate-700 shadow-sm flex flex-col justify-between">
            <span class="text-[9px] uppercase font-black text-slate-400 tracking-widest mb-1">${i.l}</span>
            <div class="flex items-end justify-between">
                <div class="text-sm font-bold text-slate-500 dark:text-slate-400">Old: <b class="text-slate-800 dark:text-white">${v1}</b></div>
                <div class="text-${i.c}-600 font-black text-lg">${v2}</div>
            </div>
            <div class="text-[10px] font-bold ${color} mt-1 text-right">${icon} ${diff > 0 ? '+'+diff : diff}</div>
         </div>`;
      }).join('');
      document.getElementById('cmpStatGrid').innerHTML = htmlStats;
      
      const v = compareState.versions;
      const d1 = v.b.v1 - v.a.v1;
      const d2 = v.b.v2 - v.a.v2;
      const d3 = v.b.both - v.a.both;

      document.getElementById('cmpVersionGrid').innerHTML = `
          <div class="bg-white dark:bg-slate-800 p-3 rounded-xl border border-slate-100 dark:border-slate-700 shadow-sm flex flex-col justify-between">
            <span class="text-[9px] uppercase font-black text-slate-400 tracking-widest mb-1">Version 1</span>
            <div class="flex items-end justify-between">
                <div class="text-sm font-bold text-slate-500">Old: <b class="text-slate-800 dark:text-white">${v.a.v1}</b></div>
                <div class="text-indigo-600 font-black text-lg">${v.b.v1}</div>
            </div>
            <div class="text-[10px] font-bold ${d1>=0?'text-green-500':'text-red-500'} mt-1 text-right">${d1>0?'+':''}${d1}</div>
          </div>
          <div class="bg-white dark:bg-slate-800 p-3 rounded-xl border border-slate-100 dark:border-slate-700 shadow-sm flex flex-col justify-between">
            <span class="text-[9px] uppercase font-black text-slate-400 tracking-widest mb-1">Version 2</span>
            <div class="flex items-end justify-between">
                <div class="text-sm font-bold text-slate-500">Old: <b class="text-slate-800 dark:text-white">${v.a.v2}</b></div>
                <div class="text-indigo-600 font-black text-lg">${v.b.v2}</div>
            </div>
            <div class="text-[10px] font-bold ${d2>=0?'text-green-500':'text-red-500'} mt-1 text-right">${d2>0?'+':''}${d2}</div>
          </div>
          <div class="bg-white dark:bg-slate-800 p-3 rounded-xl border border-slate-100 dark:border-slate-700 shadow-sm flex flex-col justify-between">
            <span class="text-[9px] uppercase font-black text-slate-400 tracking-widest mb-1">Both</span>
            <div class="flex items-end justify-between">
                <div class="text-sm font-bold text-slate-500">Old: <b class="text-slate-800 dark:text-white">${v.a.both}</b></div>
                <div class="text-indigo-600 font-black text-lg">${v.b.both}</div>
            </div>
            <div class="text-[10px] font-bold ${d3>=0?'text-green-500':'text-red-500'} mt-1 text-right">${d3>0?'+':''}${d3}</div>
          </div>
      `;

      if (window.__cmpA) window.__cmpA.destroy(); if (window.__cmpB) window.__cmpB.destroy();
      const cfg = (s) => ({ type: 'doughnut', data: { labels: ['Operational', 'Developmental', 'With LOI', 'No LOI'], datasets: [{ data: [s.op, s.dev, s.loi, s.no], backgroundColor: ['#22c55e', '#3b82f6', '#f59e0b', '#ef4444'], borderWidth: 0 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: true, position: 'bottom' } } } });
      window.__cmpA = new Chart(document.getElementById('cmpChartA'), cfg(compareState.statsA));
      window.__cmpB = new Chart(document.getElementById('cmpChartB'), cfg(compareState.statsB));
      
      const rowHtml = compareState.changedRows.map((r, i) => `
        <tr class="border-b border-slate-50 dark:border-slate-800">
          <td class="px-5 py-4 font-black text-slate-800 dark:text-slate-200">${r.Municipality}<div class="text-[9px] text-slate-400 font-normal uppercase">${r.Province}</div></td>
          <td class="px-5 py-4 text-xs bg-red-50 dark:bg-red-900/10 text-red-600 border-l dark:border-slate-800">${r.oldStatus||'-'}</td>
          <td class="px-5 py-4 text-xs font-black bg-green-50 dark:bg-green-900/10 text-green-700">${r.newStatus||'-'}</td>
          <td class="px-5 py-4 text-right"><button onclick="viewSingleDiff(${i})" class="text-[10px] bg-slate-100 dark:bg-slate-800 px-3 py-1 rounded font-bold hover:bg-dict-blue hover:text-white transition">View Details</button></td>
        </tr>`).join('');
        
      document.getElementById('cmpChangedTableFull').innerHTML = rowHtml || `<tr><td class="px-5 py-8 text-center text-slate-500" colspan="4">No Status Changes Detected</td></tr>`;
    }

    function viewAllChanges() {
        if (!compareState || !compareState.changedRows) return;
        document.getElementById('allChangesCount').innerText = compareState.changedRows.length;
        const rowHtml = compareState.changedRows.map((r, i) => `
        <tr class="border-b border-slate-50 dark:border-slate-800 hover:bg-slate-50 dark:hover:bg-slate-800/50 transition">
          <td class="px-6 py-4 font-black text-slate-800 dark:text-slate-200">${r.Municipality}<div class="text-[9px] text-slate-400 font-normal uppercase">${r.Province}</div></td>
          <td class="px-6 py-4 text-xs bg-red-50 dark:bg-red-900/10 text-red-600 border-l dark:border-slate-800">${r.oldStatus||'-'}</td>
          <td class="px-6 py-4 text-xs font-black bg-green-50 dark:bg-green-900/10 text-green-700">${r.newStatus||'-'}</td>
          <td class="px-6 py-4 text-right"><button onclick="viewSingleDiff(${i})" class="text-[10px] bg-slate-100 dark:bg-slate-800 px-3 py-1 rounded font-bold hover:bg-dict-blue hover:text-white transition">View Details</button></td>
        </tr>`).join('');
        
        document.getElementById('allChangesBody').innerHTML = rowHtml || `<tr><td class="px-6 py-12 text-center text-slate-500" colspan="4">No Status Changes Detected</td></tr>`;
        openModal('modalAllChanges');
    }

    function viewSingleDiff(idx) {
        const item = compareState.changedRows[idx];
        document.getElementById('singleDiffTitle').innerText = `Changes: ${item.Municipality}`;
        const tbody = document.getElementById('singleDiffBody');
        tbody.innerHTML = ''; 

        const groups = { "Overall Remarks": [] };
        Object.keys(EDIT_FORM_CONFIG).forEach(sec => groups[sec] = []);
        groups["Other Changes"] = [];

        item.diffs.forEach(d => {
            const k = d.key.toLowerCase();
            if (k.includes('overall remarks') || k === 'remarks') {
                groups["Overall Remarks"].push(d);
                return;
            }
            let found = false;
            for (const [secName, fields] of Object.entries(EDIT_FORM_CONFIG)) {
                const match = fields.some(f => f.keys.some(fk => fk.toLowerCase() === k));
                if (match || fields.some(f => f.label.toLowerCase() === k)) {
                      groups[secName].push(d);
                      found = true;
                      break;
                }
            }
            if (!found) groups["Other Changes"].push(d);
        });

        const order = ["Overall Remarks", ...Object.keys(EDIT_FORM_CONFIG), "Other Changes"];

        order.forEach(sec => {
            const diffs = groups[sec];
            if (diffs && diffs.length > 0) {
                const isRemarks = sec === "Overall Remarks";
                const headerClass = isRemarks 
                    ? "bg-blue-100 dark:bg-blue-900/40 text-blue-700 dark:text-blue-200 border-l-4 border-blue-500" 
                    : "bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300";

                tbody.innerHTML += `
                    <tr class="${headerClass} border-b dark:border-slate-700">
                        <td colspan="3" class="px-4 py-2 text-xs font-black uppercase tracking-widest">${sec}</td>
                    </tr>`;

                diffs.forEach(d => {
                      tbody.innerHTML += `
                      <tr class="bg-white dark:bg-slate-900">
                        <td class="px-4 py-3 font-bold text-slate-600 dark:text-slate-400 border-b dark:border-slate-800 text-[11px] uppercase align-top">${d.key}</td>
                        <td class="px-4 py-3 text-red-600 bg-red-50 dark:bg-red-900/20 border-b dark:border-slate-800 break-words text-xs align-top">${d.old || '<em class="opacity-50">Empty</em>'}</td>
                        <td class="px-4 py-3 text-green-600 bg-green-50 dark:bg-green-900/20 border-b dark:border-slate-800 break-words text-xs align-top">${d.new || '<em class="opacity-50">Empty</em>'}</td>
                      </tr>`;
                });
            }
        });

        openModal('modalSingleDiff');
    }
    
    function exitCompareMode() { document.getElementById('compareBanner').classList.add('hidden'); compareState = null; CURRENT_VIEW_DB = LIVE_DB; renderDashboard(); if (document.getElementById('view-map') && !document.getElementById('view-map').classList.contains('hidden')) { if (!map) initMap(); else renderMapMarkers(CURRENT_VIEW_DB); } }
    function switchTab(t) { document.querySelectorAll('.view-section').forEach(e => e.classList.add('hidden')); document.getElementById(`view-${t}`).classList.remove('hidden'); document.querySelectorAll('.nav-tab').forEach(b => b.classList.remove('active')); document.getElementById(`btn-${t}`).classList.add('active'); if (t === 'map') initMap(); }
    function sortData(col) { if (sortCol === col) sortAsc = !sortAsc; else { sortCol = col; sortAsc = true; } resetPg(); applyFilters(); }
    function changePg(dir) { curPage += dir; if (curPage < 1) curPage = 1; applyFilters(); }
    function toggleTheme() { document.documentElement.classList.toggle('dark'); localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light'); renderCharts(); if (compareState && document.getElementById('modalCompare').classList.contains('active')) renderCompareModal(); }
    function toggleSettings() { document.getElementById('settingsBar').classList.toggle('hidden'); }

    /* --- ADDED AI REPORT FEATURES --- */
    function triggerAiReport() {
        // Instead of directly exporting, send a prompt to the AI chat
        setChatQuery("Generate a comprehensive summary report of the current dashboard data.");
    }

    // Helper to generate simple algorithmic summaries for the PDF
    function generateTextSummary(type, data) {
        const stats = getStatsFrom(data);
        const total = stats.total || 1;
        const opPct = ((stats.op/total)*100).toFixed(1);
        
        if (type === 'kpi') {
            return `Current analysis shows a total of ${stats.total} Local Government Units (LGUs). The operational rate stands at ${opPct}%, with ${stats.op} LGUs fully operational. There are currently ${stats.no} LGUs that have not yet submitted a Letter of Intent (LOI), representing ${((stats.no/total)*100).toFixed(1)}% of the target.`;
        } else if (type === 'timeline') {
            return `The timeline indicates a consistent upward trend in operational status. The system has seen significant adoption growth, particularly in the most recent year recorded. The gap between overall engagement and full operational status is narrowing, indicating successful onboarding processes.`;
        } else if (type === 'provincial') {
            // Find top province
            const provs = {};
            data.forEach(d => { if(d.Status === 'Operational') provs[d.Province] = (provs[d.Province] || 0) + 1; });
            const topProv = Object.keys(provs).reduce((a, b) => provs[a] > provs[b] ? a : b, Object.keys(provs)[0] || 'None');
            
            return `Provincial breakdown highlights diverse adoption rates across regions. ${topProv} is currently leading in terms of Operational LGUs. Targeted interventions may be required for provinces showing high counts of 'No LOI' status to improve national coverage.`;
        }
        return "";
    }

    /* --- UPDATED EXPORT FUNCTION WITH AI SUMMARY & TABLES --- */
    function exportReport(type) {
        if (!CURRENT_VIEW_DB || CURRENT_VIEW_DB.length === 0) return alert("No data to export.");

        // Fix: If on Map or AI tab, force switch to dashboard to ensure charts are rendered for capture
        if (type === 'pdf' && document.getElementById('view-dash').classList.contains('hidden')) {
            showLoading("Generating PDF...");
            switchTab('dash');
            // Allow charts to render
            setTimeout(() => {
                exportReport(type);
                hideLoading();
            }, 800);
            return;
        }
        
        const now = new Date().toLocaleString('en-US');
        const fileName = `eLGU_Report_${activeFilter}_${new Date().toISOString().slice(0,10)}`;

        if (type === 'csv') {
            const headers = ["ID", "Province", "Municipality", "Region", "Level", "Income Class", "Status", "e-Readiness", "Op / Train Date", "Remarks"];
            const csvRows = [headers.join(',')];
            CURRENT_VIEW_DB.forEach(row => {
                const st = (row.Status || '').toLowerCase();
                const displayDate = (st.includes('developmental') && row.TrainDate) ? row.TrainDate : (row.OpDate || '');

                const vals = [row.ID, row.Province, row.Municipality, row._raw['Region']||'', row._raw['Level']||'', row._raw['Income Class']||'', row.Status, row.EReadiness||'-', displayDate, row.Remarks];
                csvRows.push(vals.map(v => `"${String(v||'').replace(/"/g, '""')}"`).join(','));
            });
            const blob = new Blob([csvRows.join('\n')], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = fileName + ".csv"; a.click(); window.URL.revokeObjectURL(url);
        } 
        else if (type === 'pdf') {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const pageWidth = doc.internal.pageSize.getWidth();
            const margin = 14;
            let y = 14;

            // --- PAGE 1: EXECUTIVE SUMMARY & PIE CHART ---
            doc.setFillColor(0, 51, 153);
            doc.rect(0, 0, pageWidth, 24, 'F');
            doc.setFontSize(18); doc.setTextColor(255, 255, 255); doc.setFont("helvetica", "bold");
            doc.text("eLGU Monitoring Report", margin, 16);
            doc.setFontSize(10); doc.setFont("helvetica", "normal");
            doc.text(`Generated: ${now}`, margin, 21);
            doc.text(`Filter: ${activeFilter}`, pageWidth - margin, 16, { align: 'right' });
            y = 35;

            // KPIs
            doc.setFontSize(12); doc.setTextColor(0, 51, 153); doc.setFont("helvetica", "bold");
            doc.text("1. Executive Summary", margin, y);
            y += 8;
            
            const s = getStatsFrom(CURRENT_VIEW_DB);
            const boxGap = 4;
            const boxW = (pageWidth - (margin * 2) - (boxGap * 4)) / 5;
            const kpiConfig = [
                { label: "TOTAL LGUs", val: s.total, bg: [241, 245, 249], text: [71, 85, 105] },
                { label: "OPERATIONAL", val: s.op, bg: [220, 252, 231], text: [22, 163, 74] },
                { label: "DEVELOPMENTAL", val: s.dev, bg: [219, 234, 254], text: [37, 99, 235] },
                { label: "WITH LOI", val: s.loi, bg: [254, 243, 199], text: [217, 119, 6] },
                { label: "NO LOI", val: s.no, bg: [254, 226, 226], text: [220, 38, 38] }
            ];

            kpiConfig.forEach((k, i) => {
                const bx = margin + (i * (boxW + boxGap));
                doc.setFillColor(...k.bg); doc.setDrawColor(200, 200, 200);
                doc.roundedRect(bx, y, boxW, 24, 2, 2, 'FD');
                doc.setFontSize(7); doc.setTextColor(100); doc.setFont("helvetica", "bold");
                doc.text(k.label, bx + 3, y + 8);
                doc.setFontSize(14); doc.setTextColor(...k.text);
                doc.text(String(k.val), bx + 3, y + 19);
            });
            y += 35;

            doc.setFontSize(11); doc.setTextColor(50);
            doc.text("Status Distribution", margin, y);
            y += 5;

            try {
                const canvasPie = document.getElementById('chartPie');
                const imgPie = canvasPie.toDataURL('image/png');
                const ratio = canvasPie.width / canvasPie.height;
                const pdfChartHeight = 60; 
                const pdfChartWidth = pdfChartHeight * ratio;
                const xPos = (pageWidth - pdfChartWidth) / 2;
                
                doc.addImage(imgPie, 'PNG', xPos, y, pdfChartWidth, pdfChartHeight);
                y += pdfChartHeight + 5;

                // ** ADD PIE CHART DETAILS TABLE **
                const pieTableData = [
                    ['Operational', s.op, ((s.op/s.total)*100).toFixed(1) + '%', `V1: ${getVersionStats(CURRENT_VIEW_DB, 'operational').v1}, V2: ${getVersionStats(CURRENT_VIEW_DB, 'operational').v2}`],
                    ['Developmental', s.dev, ((s.dev/s.total)*100).toFixed(1) + '%', `V1: ${getVersionStats(CURRENT_VIEW_DB, 'developmental').v1}, V2: ${getVersionStats(CURRENT_VIEW_DB, 'developmental').v2}`],
                    ['With LOI', s.loi, ((s.loi/s.total)*100).toFixed(1) + '%', '-'],
                    ['No LOI', s.no, ((s.no/s.total)*100).toFixed(1) + '%', '-']
                ];
                
                doc.autoTable({
                    startY: y,
                    head: [['Status', 'Count', 'Percentage', 'Version Details']],
                    body: pieTableData,
                    theme: 'striped',
                    headStyles: { fillColor: [0, 51, 153], fontSize: 9 },
                    styles: { fontSize: 8, cellPadding: 2 },
                    margin: { left: margin, right: margin }
                });
                y = doc.lastAutoTable.finalY + 15;

            } catch (e) { console.error(e); }

            // --- PAGE 2: TIMELINE ---
            doc.addPage();
            y = margin;
            doc.setFontSize(12); doc.setTextColor(0, 51, 153); doc.setFont("helvetica", "bold");
            doc.text("2. Timeline Progress", margin, y);
            y += 8;

            doc.setFontSize(9); doc.setTextColor(80); doc.setFont("helvetica", "italic");
            const summary2 = generateTextSummary('timeline', CURRENT_VIEW_DB);
            const splitSummary2 = doc.splitTextToSize(summary2, pageWidth - (margin * 2));
            doc.text(splitSummary2, margin, y);
            y += (splitSummary2.length * 5) + 5;

            try {
                const imgYear = document.getElementById('chartYear').toDataURL('image/png');
                doc.addImage(imgYear, 'PNG', margin, y, pageWidth - (margin * 2), 70);
                y += 75;

                // ** ADD TIMELINE DETAILS TABLE **
                const yearlyData = {};
                CURRENT_VIEW_DB.forEach(d => { 
                    const st = (d.Status || '').toLowerCase();
                    const targetDate = (st.includes('developmental') && d.TrainDate) ? d.TrainDate : d.OpDate;

                    const yrMatch = String(targetDate || "").match(/\d{4}/);
                    if(yrMatch) { 
                        const yr = yrMatch[0];
                        if(!yearlyData[yr]) yearlyData[yr] = { op: 0, dev: 0 }; 
                        if(st.includes('operational')) yearlyData[yr].op++; 
                        else if(st.includes('developmental')) yearlyData[yr].dev++; 
                    } 
                });
                const years = Object.keys(yearlyData).sort();
                let accOp = 0, accDev = 0;
                const timelineBody = years.map(yr => {
                      accOp += yearlyData[yr].op;
                      accDev += yearlyData[yr].dev;
                      return [yr, accOp + accDev, accOp, accDev];
                });

                doc.autoTable({
                    startY: y,
                    head: [['Year', 'Total Cumulative', 'Operational', 'Developmental']],
                    body: timelineBody,
                    theme: 'striped',
                    headStyles: { fillColor: [79, 70, 229], fontSize: 9 },
                    styles: { fontSize: 8, cellPadding: 2 },
                    margin: { left: margin, right: margin }
                });

            } catch (e) { console.error(e); }

            // --- PAGE 3: PROVINCIAL ---
            doc.addPage();
            y = margin;
            doc.setFontSize(12); doc.setTextColor(0, 51, 153); doc.setFont("helvetica", "bold");
            doc.text("3. Provincial Breakdown", margin, y);
            y += 8;

            doc.setFontSize(9); doc.setTextColor(80); doc.setFont("helvetica", "italic");
            const summary3 = generateTextSummary('provincial', CURRENT_VIEW_DB);
            const splitSummary3 = doc.splitTextToSize(summary3, pageWidth - (margin * 2));
            doc.text(splitSummary3, margin, y);
            y += (splitSummary3.length * 5) + 5;

            try {
                const imgBar = document.getElementById('chartBar').toDataURL('image/png');
                doc.addImage(imgBar, 'PNG', margin, y, pageWidth - (margin * 2), 70);
                y += 75;

                // ** ADD PROVINCIAL DETAILS TABLE **
                const provs = [...new Set(CURRENT_VIEW_DB.map(x => x.Province).filter(Boolean))].sort();
                const provBody = provs.map(p => { 
                    const sub = CURRENT_VIEW_DB.filter(d => d.Province === p); 
                    const ls = getStatsFrom(sub);
                    return [p, ls.op, ls.dev, ls.loi, ls.no, ls.total];
                }).sort((a,b) => b[5] - a[5]); // Sort by Total

                doc.autoTable({
                    startY: y,
                    head: [['Province', 'Operational', 'Developmental', 'With LOI', 'No LOI', 'Total']],
                    body: provBody,
                    theme: 'striped',
                    headStyles: { fillColor: [59, 130, 246], fontSize: 9 },
                    styles: { fontSize: 8, cellPadding: 2 },
                    margin: { left: margin, right: margin }
                });

            } catch (e) { console.error(e); }

            // --- PAGE 4: MASTER LIST (GROUPED BY PROVINCE) ---
            doc.addPage();
            y = margin;
            doc.setFontSize(14); doc.setTextColor(0, 51, 153); doc.setFont("helvetica", "bold");
            doc.text("Master List Data", margin, y);
            y += 10;

            const uniqueProvs = [...new Set(CURRENT_VIEW_DB.map(x => x.Province).filter(Boolean))].sort();

            uniqueProvs.forEach((prov) => {
                if (y + 25 > doc.internal.pageSize.getHeight()) { doc.addPage(); y = margin; }

                doc.setFontSize(11); doc.setTextColor(50); doc.setFont("helvetica", "bold");
                doc.text(prov, margin, y);
                y += 5;

                const provRows = CURRENT_VIEW_DB.filter(d => d.Province === prov);
                const tableBody = provRows.map(row => {
                    const st = (row.Status || '').toLowerCase();
                    const displayDate = (st.includes('developmental') && row.TrainDate) ? row.TrainDate : (row.OpDate || '-');

                    return [row.Municipality, row.Status, row.EReadiness || '-', displayDate, row.Remarks || '-'];
                });

                doc.autoTable({
                    startY: y,
                    head: [['Municipality', 'Status', 'e-Readiness', 'Op / Train Date', 'Remarks']],
                    body: tableBody,
                    theme: 'grid',
                    headStyles: { fillColor: [0, 51, 153], fontSize: 9 },
                    styles: { fontSize: 8, cellPadding: 2 },
                    columnStyles: { 0: {cellWidth:40, fontStyle:'bold'}, 1: {cellWidth:25}, 2: {cellWidth:25}, 3: {cellWidth:25}, 4: {cellWidth:'auto'} },
                    didParseCell: function(data) {
                        if (data.section === 'body' && data.column.index === 1) {
                            const t = data.cell.text[0].toLowerCase();
                            if (t.includes('operational')) data.cell.styles.textColor = [34, 197, 94];
                            else if (t.includes('developmental')) data.cell.styles.textColor = [59, 130, 246];
                            else if (t.includes('no loi')) data.cell.styles.textColor = [239, 68, 68];
                            else data.cell.styles.textColor = [245, 158, 11];
                        }
                    },
                    margin: { left: margin, right: margin }
                });

                y = doc.lastAutoTable.finalY + 10;
            });

            doc.save(fileName + ".pdf");
        }
    }
 </script>
</body>
</html>
